<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhooks Management - Finanza Admin</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .admin-nav { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9rem; margin-top: 5px; }
        .dashboard-section { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .chart-container { position: relative; height: 300px; margin-bottom: 20px; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
        .btn-primary { background: #667eea; border: none; }
        .btn-primary:hover { background: #5568d3; }
        .table-responsive { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-failed { background: #f5c2c7; color: #661d1e; }
        .event-type-tag { display: inline-block; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-size: 0.85rem; margin: 2px; }
        .code-block { background: #f5f5f5; border-left: 3px solid #667eea; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; overflow-x: auto; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="admin-nav navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/user/admin/dashboard">
                <i class="fas fa-chart-line"></i> Finanza Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/user/admin/dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/user/admin/monitoring">Monitoring</a></li>
                    <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-5 mb-5">
        <!-- Header -->
        <div class="admin-header">
            <h1><i class="fas fa-plug"></i> Webhooks Management</h1>
            <p class="mb-0">Configure, monitor, and manage webhook subscriptions and event delivery</p>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-number" id="totalWebhooks">-</div>
                    <div class="stat-label">Total Subscriptions</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-number" id="activeWebhooks">-</div>
                    <div class="stat-label">Active Webhooks</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-number" id="deliveryRate">-</div>
                    <div class="stat-label">Success Rate (24h)</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-number" id="failedDeliveries">-</div>
                    <div class="stat-label">Failed Deliveries (24h)</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-5">
            <div class="col-lg-6">
                <div class="dashboard-section">
                    <h5>Delivery Performance (7 days)</h5>
                    <div class="chart-container">
                        <canvas id="deliveryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-section">
                    <h5>Event Type Distribution</h5>
                    <div class="chart-container">
                        <canvas id="eventTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webhook Subscriptions -->
        <div class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5><i class="fas fa-list"></i> Webhook Subscriptions</h5>
                <button class="btn btn-primary btn-sm" onclick="openModal('createWebhookModal')">
                    <i class="fas fa-plus"></i> New Webhook
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>URL</th>
                            <th>Event Types</th>
                            <th>Active</th>
                            <th>Status</th>
                            <th>Deliveries (24h)</th>
                            <th>Success Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="webhooksTable">
                        <tr><td colspan="8" class="text-center text-muted">Loading webhooks...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Failed Deliveries -->
        <div class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5><i class="fas fa-exclamation-triangle"></i> Failed Deliveries</h5>
                <button class="btn btn-warning btn-sm" onclick="retryFailedDeliveries()">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Delivery ID</th>
                            <th>Webhook</th>
                            <th>Event</th>
                            <th>Attempts</th>
                            <th>Last Error</th>
                            <th>Timestamp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="failedTable">
                        <tr><td colspan="7" class="text-center text-muted">Loading failed deliveries...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Delivery Logs -->
        <div class="dashboard-section">
            <h5><i class="fas fa-history"></i> Recent Deliveries</h5>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Delivery ID</th>
                            <th>Webhook</th>
                            <th>Event</th>
                            <th>Status</th>
                            <th>HTTP Status</th>
                            <th>Response Time</th>
                            <th>Timestamp</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryLogsTable">
                        <tr><td colspan="8" class="text-center text-muted">Loading delivery logs...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Event Types Reference -->
        <div class="dashboard-section">
            <h5><i class="fas fa-book"></i> Available Event Types</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6>Transaction Events</h6>
                    <div id="transactionEvents"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <h6>User & Account Events</h6>
                    <div id="userEvents"></div>
                </div>
            </div>
        </div>

        <!-- Retry Policy Configuration -->
        <div class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5><i class="fas fa-cogs"></i> Retry Policy Configuration</h5>
                <button class="btn btn-primary btn-sm" onclick="openModal('retryPolicyModal')">
                    <i class="fas fa-edit"></i> Configure
                </button>
            </div>
            <div id="retryPolicyContainer">
                <p class="text-muted">Loading retry policy...</p>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;"></div>

    <!-- Create Webhook Modal -->
    <div class="modal fade" id="createWebhookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Webhook Subscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createWebhookForm" onsubmit="handleCreateWebhook(event)">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Webhook URL</label>
                            <input type="url" class="form-control" id="webhookUrl" placeholder="https://example.com/webhook" required>
                            <small class="text-muted">HTTPS endpoints only</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Event Types</label>
                            <div id="eventTypesCheckboxes"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Authentication</label>
                            <select class="form-control" id="authType">
                                <option value="none">None</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="basic">Basic Auth</option>
                                <option value="api_key">API Key</option>
                            </select>
                        </div>
                        <div class="mb-3" id="authCredentials" style="display:none;">
                            <label class="form-label">Credentials</label>
                            <input type="text" class="form-control" id="authCredential" placeholder="Token or credentials">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="active" checked>
                            <label class="form-check-label" for="active">Active</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Webhook</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Retry Policy Modal -->
    <div class="modal fade" id="retryPolicyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configure Retry Policy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="retryPolicyForm" onsubmit="handleUpdateRetryPolicy(event)">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Max Retry Attempts</label>
                            <input type="number" class="form-control" id="maxRetries" value="5" min="1" max="20">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Initial Retry Delay (seconds)</label>
                            <input type="number" class="form-control" id="retryDelay" value="60" min="1" max="3600">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Backoff Strategy</label>
                            <select class="form-control" id="backoffStrategy">
                                <option value="linear">Linear</option>
                                <option value="exponential">Exponential</option>
                                <option value="fixed">Fixed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Timeout (seconds)</label>
                            <input type="number" class="form-control" id="timeout" value="30" min="5" max="120">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Policy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin_static/js/auth-helper.js"></script>
    <script src="/admin_static/js/admin-utils.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let deliveryChart = null;
        let eventTypeChart = null;

        const EVENT_TYPES = {
            'transaction.created': 'Transaction Created',
            'transaction.completed': 'Transaction Completed',
            'transaction.failed': 'Transaction Failed',
            'user.created': 'User Created',
            'user.updated': 'User Updated',
            'kyc.submitted': 'KYC Submitted',
            'kyc.approved': 'KYC Approved',
            'kyc.rejected': 'KYC Rejected',
            'account.created': 'Account Created',
            'payment.processed': 'Payment Processed',
            'settlement.completed': 'Settlement Completed',
            'fraud.detected': 'Fraud Detected'
        };

        document.addEventListener('DOMContentLoaded', async function() {
            await loadWebhookMetrics();
            await loadWebhooks();
            await loadFailedDeliveries();
            await loadDeliveryLogs();
            populateEventTypes();
            initCharts();

            // Setup auth type change handler
            document.getElementById('authType').addEventListener('change', (e) => {
                document.getElementById('authCredentials').style.display = 
                    e.target.value === 'none' ? 'none' : 'block';
            });
        });

        async function loadWebhookMetrics() {
            try {
                const response = await fetchAPI('/api/v1/webhooks/metrics');
                if (!response) return;
                
                document.getElementById('totalWebhooks').textContent = response.total_webhooks || 0;
                document.getElementById('activeWebhooks').textContent = response.active_webhooks || 0;
                document.getElementById('deliveryRate').textContent = (response.success_rate || 0).toFixed(1) + '%';
                document.getElementById('failedDeliveries').textContent = response.failed_24h || 0;
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadWebhooks() {
            try {
                const response = await fetchAPI('/api/v1/webhooks?limit=50');
                if (!response || !response.data) return;
                
                const tbody = document.getElementById('webhooksTable');
                tbody.innerHTML = response.data.map(webhook => `
                    <tr>
                        <td><strong>${webhook.id}</strong></td>
                        <td><code style="font-size: 0.85rem;">${webhook.url.substring(0, 40)}...</code></td>
                        <td>${webhook.event_types?.map(e => `<span class="event-type-tag">${e.substring(0, 20)}</span>`).join('')}</td>
                        <td><span class="badge bg-${webhook.active ? 'success' : 'secondary'}">${webhook.active ? 'Yes' : 'No'}</span></td>
                        <td><span class="status-badge status-${webhook.last_status === 'success' ? 'active' : 'failed'}">${webhook.last_status}</span></td>
                        <td>${webhook.deliveries_24h || 0}</td>
                        <td>${(webhook.success_rate || 0).toFixed(1)}%</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewWebhook(${webhook.id})"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="editWebhook(${webhook.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWebhook(${webhook.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="8" class="text-center text-muted">No webhooks found</td></tr>';
            } catch (error) {
                console.error('Error loading webhooks:', error);
            }
        }

        async function loadFailedDeliveries() {
            try {
                const response = await fetchAPI('/api/v1/webhooks/deliveries/failed?limit=20');
                if (!response || !response.data) return;
                
                const tbody = document.getElementById('failedTable');
                tbody.innerHTML = response.data.map(delivery => `
                    <tr>
                        <td>${delivery.id}</td>
                        <td>${delivery.webhook_url.substring(0, 30)}...</td>
                        <td>${delivery.event_type}</td>
                        <td>${delivery.attempt_count}</td>
                        <td><code style="font-size: 0.75rem;">${delivery.last_error.substring(0, 50)}...</code></td>
                        <td>${formatDate(delivery.timestamp)}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="retryDelivery(${delivery.id})"><i class="fas fa-redo"></i> Retry</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="7" class="text-center text-muted">No failed deliveries</td></tr>';
            } catch (error) {
                console.error('Error loading failed deliveries:', error);
            }
        }

        async function loadDeliveryLogs() {
            try {
                const response = await fetchAPI('/api/v1/webhooks/deliveries?limit=20');
                if (!response || !response.data) return;
                
                const tbody = document.getElementById('deliveryLogsTable');
                tbody.innerHTML = response.data.map(log => `
                    <tr>
                        <td>${log.id}</td>
                        <td>${log.webhook_url.substring(0, 30)}...</td>
                        <td>${log.event_type}</td>
                        <td><span class="badge bg-${log.status === 'success' ? 'success' : 'danger'}">${log.status}</span></td>
                        <td>${log.http_status || 'N/A'}</td>
                        <td>${log.response_time_ms}ms</td>
                        <td>${formatDate(log.timestamp)}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="viewDeliveryLog(${log.id})">View</button></td>
                    </tr>
                `).join('') || '<tr><td colspan="8" class="text-center text-muted">No delivery logs</td></tr>';
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function populateEventTypes() {
            const container = document.getElementById('eventTypesCheckboxes');
            const transactionContainer = document.getElementById('transactionEvents');
            const userContainer = document.getElementById('userEvents');
            
            let transactionHTML = '';
            let userHTML = '';
            let checkboxHTML = '';

            Object.entries(EVENT_TYPES).forEach(([key, label]) => {
                const checkbox = `<div class="form-check"><input type="checkbox" class="form-check-input" name="eventType" value="${key}" id="event_${key}"><label class="form-check-label" for="event_${key}">${label}</label></div>`;
                checkboxHTML += checkbox;

                const badge = `<span class="event-type-tag">${label}</span>`;
                if (key.startsWith('transaction')) {
                    transactionHTML += badge;
                } else {
                    userHTML += badge;
                }
            });

            container.innerHTML = checkboxHTML;
            transactionContainer.innerHTML = transactionHTML;
            userContainer.innerHTML = userHTML;
        }

        function initCharts() {
            // Delivery Chart
            const deliveryCtx = document.getElementById('deliveryChart')?.getContext('2d');
            if (deliveryCtx) {
                deliveryChart = new Chart(deliveryCtx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Successful',
                            data: [280, 290, 275, 285, 295, 310, 320],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Failed',
                            data: [12, 8, 15, 10, 7, 5, 8],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Event Type Chart
            const eventCtx = document.getElementById('eventTypeChart')?.getContext('2d');
            if (eventCtx) {
                eventTypeChart = new Chart(eventCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.values(EVENT_TYPES).slice(0, 6),
                        datasets: [{
                            data: [150, 120, 100, 80, 60, 50],
                            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4ecdc4', '#44a5c2']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        async function handleCreateWebhook(event) {
            event.preventDefault();
            const eventTypes = Array.from(document.querySelectorAll('input[name="eventType"]:checked')).map(e => e.value);
            
            const webhookData = {
                url: document.getElementById('webhookUrl').value,
                event_types: eventTypes,
                auth_type: document.getElementById('authType').value,
                auth_credential: document.getElementById('authCredential').value || null,
                active: document.getElementById('active').checked
            };

            try {
                const response = await fetch('/api/v1/webhooks', {
                    method: 'POST',
                    headers: AUTH_HEADER(),
                    body: JSON.stringify(webhookData)
                });
                
                if (!response.ok) throw new Error('Failed to create webhook');
                
                showAlert('Webhook created successfully', 'success');
                closeModal('createWebhookModal');
                await loadWebhooks();
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        async function retryDelivery(deliveryId) {
            try {
                const response = await fetch(`/api/v1/webhooks/deliveries/${deliveryId}/retry`, {
                    method: 'POST',
                    headers: AUTH_HEADER()
                });
                
                if (!response.ok) throw new Error('Retry failed');
                showAlert('Delivery retry queued', 'success');
                await loadFailedDeliveries();
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        async function retryFailedDeliveries() {
            if (confirm('Retry all failed deliveries from last 24h?')) {
                try {
                    const response = await fetch('/api/v1/webhooks/deliveries/retry-failed', {
                        method: 'POST',
                        headers: AUTH_HEADER()
                    });
                    
                    if (!response.ok) throw new Error('Retry failed');
                    const data = await response.json();
                    showAlert(`Queued ${data.count} deliveries for retry`, 'success');
                    await loadFailedDeliveries();
                } catch (error) {
                    showAlert('Error: ' + error.message, 'danger');
                }
            }
        }

        async function handleUpdateRetryPolicy(event) {
            event.preventDefault();
            
            const policy = {
                max_retries: parseInt(document.getElementById('maxRetries').value),
                retry_delay_seconds: parseInt(document.getElementById('retryDelay').value),
                backoff_strategy: document.getElementById('backoffStrategy').value,
                timeout_seconds: parseInt(document.getElementById('timeout').value)
            };

            try {
                const response = await fetch('/api/v1/webhooks/policy', {
                    method: 'PUT',
                    headers: AUTH_HEADER(),
                    body: JSON.stringify(policy)
                });
                
                if (!response.ok) throw new Error('Update failed');
                showAlert('Retry policy updated', 'success');
                closeModal('retryPolicyModal');
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        function viewWebhook(id) {
            alert('Webhook ' + id + ' details');
        }

        function editWebhook(id) {
            alert('Edit webhook ' + id);
        }

        function deleteWebhook(id) {
            if (confirm('Delete this webhook?')) {
                alert('Webhook ' + id + ' deleted');
            }
        }

        function viewDeliveryLog(id) {
            alert('Delivery log ' + id);
        }

        function openModal(modalId) {
            new bootstrap.Modal(document.getElementById(modalId)).show();
        }

        function closeModal(modalId) {
            bootstrap.Modal.getInstance(document.getElementById(modalId))?.hide();
        }

        function formatDate(date) {
            return new Date(date).toLocaleString();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
    </script>
</body>
</html>
                                <th>User</th>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Events Subscribed</th>
                                <th>Status</th>
                                <th>Success Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="webhooksTableBody">
                            <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Webhook Configuration -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Webhook Configuration</h5>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Default Retry Attempts</label>
                            <input type="number" class="form-control" value="3" min="0" max="10">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Retry Backoff (seconds)</label>
                            <input type="number" class="form-control" value="5" min="1" max="300">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Request Timeout (seconds)</label>
                            <input type="number" class="form-control" value="30" min="5" max="120">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Max Events Queue Size</label>
                            <input type="number" class="form-control" value="1000" min="100" max="10000">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableSignature" checked>
                                <label class="form-check-label" for="enableSignature">
                                    Require HMAC signature verification on all webhooks
                                </label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let deliveryChart = null;
        let eventTypeChart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                window.location.href = '/signin';
                return;
            }

            try {
                await loadMetrics();
                await loadCharts();
                await loadFailedDeliveries();
                await loadWebhooks();
            } catch (error) {
                console.error('Error loading admin data:', error);
            }

            document.getElementById('configForm').addEventListener('submit', handleConfigSubmit);
        });

        async function loadMetrics() {
            try {
                const response = await fetch('/api/admin/webhooks/metrics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('totalWebhooks').textContent = data.total_webhooks || '0';
                    document.getElementById('activeCount').textContent = 'Active: ' + (data.active_webhooks || '0');
                    
                    document.getElementById('eventsToday').textContent = data.events_24h || '0';
                    
                    document.getElementById('deliveryRate').textContent = (data.delivery_rate || 0).toFixed(2) + '%';
                    
                    document.getElementById('failedEvents').textContent = data.failed_24h || '0';
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadCharts() {
            try {
                const response = await fetch('/api/admin/webhooks/chart-data', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();

                    // Delivery Rate Chart
                    let ctx = document.getElementById('webhookDeliveryChart').getContext('2d');
                    if (deliveryChart) deliveryChart.destroy();
                    deliveryChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.days || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Delivery Rate %',
                                data: data.delivery_rates || [99.2, 99.5, 98.8, 99.1, 99.6, 99.3, 99.4],
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });

                    // Event Type Chart
                    ctx = document.getElementById('eventTypeChart').getContext('2d');
                    if (eventTypeChart) eventTypeChart.destroy();
                    eventTypeChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Transaction', 'Transfer', 'Bill Paid', 'KYC', 'Alert', 'Loan'],
                            datasets: [{
                                data: data.event_distribution || [32, 24, 18, 12, 10, 4],
                                backgroundColor: ['#667eea', '#f5576c', '#4ecdc4', '#95e1d3', '#c7ceea', '#ffa502']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        async function loadFailedDeliveries() {
            try {
                const response = await fetch('/api/admin/webhooks/failed-deliveries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('failedDeliveriesBody');
                    tbody.innerHTML = '';

                    if (data.failures && data.failures.length > 0) {
                        data.failures.forEach(failure => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${new Date(failure.timestamp).toLocaleString()}</td>
                                    <td>${failure.user_email}</td>
                                    <td><code>${failure.webhook_url}</code></td>
                                    <td><span class="badge bg-info">${failure.event_type}</span></td>
                                    <td>${failure.attempts}/${failure.max_attempts}</td>
                                    <td><small>${failure.error_message}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Retry</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading failures:', error);
            }
        }

        async function loadWebhooks() {
            try {
                const response = await fetch('/api/admin/webhooks/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('webhooksTableBody');
                    tbody.innerHTML = '';

                    if (data.webhooks && data.webhooks.length > 0) {
                        data.webhooks.forEach(webhook => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${webhook.user_email}</td>
                                    <td><strong>${webhook.name}</strong></td>
                                    <td><code>${webhook.url}</code></td>
                                    <td>${webhook.event_count} events</td>
                                    <td><span class="badge ${webhook.active ? 'bg-success' : 'bg-danger'}">${webhook.active ? 'ACTIVE' : 'INACTIVE'}</span></td>
                                    <td>${webhook.success_rate.toFixed(2)}%</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">View</button>
                                        <button class="btn btn-sm btn-outline-danger">Disable</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading webhooks:', error);
            }
        }

        function handleConfigSubmit(e) {
            e.preventDefault();
            alert('Configuration saved successfully!');
        }
    </script>
    <script src="/static/js/admin-guard.js"></script>
</body>
</html>
