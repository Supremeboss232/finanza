<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Exchange Admin - Finanza</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        .admin-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .rate-card { border-top: 3px solid #f5576c; }
        #exchangeVolumeChart, #currencyBreakdownChart { max-height: 300px; }
        .rate-input { font-size: 14px; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/user/dashboard">
                <i class="fas fa-exchange-alt"></i> Currency Exchange Administration
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cogs"></i> Admin Panel
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/user/admin/dashboard">Dashboard</a></li>
                            <li><a class="dropdown-item active" href="/user/admin/currency_exchange">Currency Exchange</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-5 mb-5">
        <!-- Header -->
        <div class="admin-header">
            <h1><i class="fas fa-exchange-alt"></i> Currency Exchange Administration</h1>
            <p class="mb-0">Manage exchange rates and monitor currency trading activity</p>
        </div>

        <!-- Key Metrics -->
        <div class="row g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Total Volume (24h)</h6>
                        <h2 id="totalVolume">$-</h2>
                        <p class="text-muted small mb-0" id="volumeTrend">↑ 12.5% from yesterday</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Active Pairs</h6>
                        <h2 id="activePairs">-</h2>
                        <p class="text-muted small mb-0">Trading pairs</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Today's Transactions</h6>
                        <h2 id="todayTransactions">-</h2>
                        <p class="text-muted small mb-0" id="todayFees">Fees: $-</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">System Status</h6>
                        <h2><span class="badge bg-success">Active</span></h2>
                        <p class="text-muted small mb-0">All systems operational</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-5">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Exchange Volume by Currency Pair</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="exchangeVolumeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Currency Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="currencyBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exchange Rate Management -->
        <div class="card mb-5">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Exchange Rate Management</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#updateRateModal">
                    <i class="fas fa-edit"></i> Update Rates
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Currency Pair</th>
                                <th>Current Rate</th>
                                <th>Buy Margin</th>
                                <th>Sell Margin</th>
                                <th>24h Change</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ratesTableBody">
                            <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Fee Configuration -->
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-percentage"></i> Fee Configuration</h5>
            </div>
            <div class="card-body">
                <form id="feeForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Standard Exchange Fee (%)</label>
                            <input type="number" class="form-control rate-input" id="standardFee" step="0.01" value="0.50">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Premium Member Fee (%)</label>
                            <input type="number" class="form-control rate-input" id="premiumFee" step="0.01" value="0.25">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Corporate Fee (%)</label>
                            <input type="number" class="form-control rate-input" id="corporateFee" step="0.01" value="0.10">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Minimum Fee ($)</label>
                            <input type="number" class="form-control rate-input" id="minimumFee" step="0.01" value="1.00">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Fee Settings</button>
                </form>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Transactions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Amount</th>
                                <th>Rate Applied</th>
                                <th>Fee</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Rate Modal -->
    <div class="modal fade" id="updateRateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Exchange Rate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateRateForm">
                        <div class="mb-3">
                            <label class="form-label">Currency Pair</label>
                            <select class="form-control" required>
                                <option value="">Select pair</option>
                                <option value="USD/EUR">USD / EUR</option>
                                <option value="USD/GBP">USD / GBP</option>
                                <option value="USD/JPY">USD / JPY</option>
                                <option value="EUR/GBP">EUR / GBP</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Rate</label>
                            <input type="number" class="form-control" step="0.0001" placeholder="1.1050" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Effective From</label>
                            <input type="datetime-local" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Update Rate</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let volumeChart = null;
        let breakdownChart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                window.location.href = '/signin';
                return;
            }

            try {
                await loadMetrics();
                await loadCharts();
                await loadExchangeRates();
                await loadRecentTransactions();
            } catch (error) {
                console.error('Error loading admin data:', error);
            }

            document.getElementById('feeForm').addEventListener('submit', handleFeeSubmit);
            document.getElementById('updateRateForm').addEventListener('submit', handleRateUpdate);
        });

        async function loadMetrics() {
            try {
                const response = await fetch('/api/v1/currency-exchange/metrics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('totalVolume').textContent = '$' + (data.total_volume || 0).toLocaleString();
                    document.getElementById('volumeTrend').textContent = data.volume_trend || '↑ 12.5%';
                    
                    document.getElementById('activePairs').textContent = data.active_pairs || '15+';
                    
                    document.getElementById('todayTransactions').textContent = data.today_transactions || '0';
                    document.getElementById('todayFees').textContent = 'Fees: $' + (data.today_fees || 0).toLocaleString();
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadCharts() {
            try {
                const response = await fetch('/api/v1/currency-exchange/chart-data', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();

                    // Volume Chart
                    let ctx = document.getElementById('exchangeVolumeChart').getContext('2d');
                    if (volumeChart) volumeChart.destroy();
                    volumeChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.pairs || ['USD/EUR', 'USD/GBP', 'USD/JPY', 'EUR/GBP', 'EUR/JPY'],
                            datasets: [{
                                label: 'Volume ($)',
                                data: data.volumes || [45000, 32000, 28000, 22000, 18000],
                                backgroundColor: '#f5576c'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });

                    // Breakdown Chart
                    ctx = document.getElementById('currencyBreakdownChart').getContext('2d');
                    if (breakdownChart) breakdownChart.destroy();
                    breakdownChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['USD', 'EUR', 'GBP', 'JPY', 'Other'],
                            datasets: [{
                                data: data.breakdown || [35, 30, 20, 10, 5],
                                backgroundColor: ['#667eea', '#f5576c', '#4ecdc4', '#95e1d3', '#c7ceea']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        async function loadExchangeRates() {
            try {
                const response = await fetch('/api/v1/currency-exchange/rates', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('ratesTableBody');
                    tbody.innerHTML = '';

                    if (data.rates && data.rates.length > 0) {
                        data.rates.forEach(rate => {
                            const changeClass = rate.change >= 0 ? 'text-success' : 'text-danger';
                            tbody.innerHTML += `
                                <tr>
                                    <td><strong>${rate.pair}</strong></td>
                                    <td>${rate.current_rate.toFixed(4)}</td>
                                    <td>${rate.buy_margin.toFixed(4)}</td>
                                    <td>${rate.sell_margin.toFixed(4)}</td>
                                    <td class="${changeClass}">${rate.change >= 0 ? '+' : ''}${rate.change.toFixed(2)}%</td>
                                    <td><span class="badge bg-success">Active</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#updateRateModal">Edit</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading rates:', error);
            }
        }

        async function loadRecentTransactions() {
            try {
                const response = await fetch('/api/v1/currency-exchange/transactions', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('transactionsBody');
                    tbody.innerHTML = '';

                    if (data.transactions && data.transactions.length > 0) {
                        data.transactions.forEach(tx => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${new Date(tx.timestamp).toLocaleString()}</td>
                                    <td>${tx.user_name}</td>
                                    <td>${tx.from_currency}</td>
                                    <td>${tx.to_currency}</td>
                                    <td>$${tx.amount.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                    <td>${tx.rate.toFixed(4)}</td>
                                    <td>$${tx.fee.toFixed(2)}</td>
                                    <td><span class="badge bg-success">${tx.status}</span></td>
                                </tr>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        function handleFeeSubmit(e) {
            e.preventDefault();
            alert('Fee settings updated successfully!');
        }

        function handleRateUpdate(e) {
            e.preventDefault();
            alert('Exchange rate updated successfully!');
            document.getElementById('updateRateForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('updateRateModal')).hide();
            loadExchangeRates();
        }
    </script>
    <script src="/static/js/admin-guard.js"></script>
</body>
</html>
