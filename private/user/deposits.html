<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Deposits - Finanza Bank</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="/static/img/favicon.ico" rel="icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600;700&family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/static/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/lib/animate/animate.min.css" rel="stylesheet">
    <link href="/static/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Navbar Start -->
    <div class="container-fluid fixed-top px-0 wow fadeIn" data-wow-delay="0.1s">
        <nav class="navbar navbar-expand-lg navbar-light py-lg-0 px-lg-5 wow fadeIn" data-wow-delay="0.1s">
            <a href="/user/dashboard" class="navbar-brand ms-4 ms-lg-0">
                <h5 class="m-0 text-primary"><i class="fa fa-university me-2"></i>Finanza</h5>
            </a>
            <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ms-auto p-4 p-lg-0">
                    <a href="/user/dashboard" class="nav-item nav-link">Dashboard</a>
                    <a href="/user/account" class="nav-item nav-link">Account</a>
                    <a href="/user/kyc_form" class="nav-item nav-link">KYC</a>
                    <div class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Products</a>
                        <div class="dropdown-menu border-light m-0">
                            <a href="/user/cards" class="dropdown-item">Cards</a>
                            <a href="/user/deposits" class="dropdown-item">Deposits</a>
                            <a href="/user/loans" class="dropdown-item">Loans</a>
                            <a href="/user/investments" class="dropdown-item">Investments</a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Services</a>
                        <div class="dropdown-menu border-light m-0">
                            <a href="/user/analytics" class="dropdown-item">Business Analysis</a>
                            <a href="/user/treasury_portfolio" class="dropdown-item">Financial Planning</a>
                            <a href="/user/insurance" class="dropdown-item">Insurance</a>
                            <a href="/user/treasury_portfolio" class="dropdown-item">Projects</a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">More</a>
                        <div class="dropdown-menu border-light m-0">
                            <a href="/user/profile" class="dropdown-item">Profile</a>
                            <a href="/user/settings" class="dropdown-item">Settings</a>
                            <a href="/user/notifications" class="dropdown-item">Notifications</a>
                            <a href="/user/contact" class="dropdown-item">Contact/Support</a>
                            <hr class="m-2">
                            <a href="/logout" class="dropdown-item text-danger">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->
    <div class="container-fluid page-header mb-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container">
            <h1 class="display-4 pb-3 animated slideInDown">Deposits</h1>
            <nav aria-label="breadcrumb animated slideInDown">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a class="text-white" href="/user/dashboard">Home</a></li>
                    <li class="breadcrumb-item text-primary active" aria-current="page">Deposits</li>
                </ol>
            </nav>
        </div>
    </div>
    <div class="container-xxl py-5">
        <div class="container">
            <div class="row g-5">
                <div class="col-lg-12 wow fadeInUp" data-wow-delay="0.1s">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1"><i class="fas fa-piggy-bank text-primary me-2"></i>Savings Deposits</h2>
                            <p class="text-muted mb-0">Grow your savings with attractive interest rates and flexible terms.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" id="refreshBtn" onclick="loadDeposits()" title="Refresh deposits data">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#depositModal">
                                <i class="fas fa-plus me-2"></i>New Deposit
                            </button>
                        </div>
                    </div>

                    <!-- Summary Statistics Cards -->
                    <div class="row mb-5">
                        <div class="col-md-3 mb-3">
                            <div class="card border-left-primary shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Deposits</div>
                                            <div class="h3 mb-0 text-gray-800" id="totalDeposits">$0.00</div>
                                        </div>
                                        <i class="fas fa-money-bill-wave fa-2x text-primary"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="depositCount">0 Active Deposits</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card border-left-success shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Balance</div>
                                            <div class="h3 mb-0 text-gray-800" id="totalBalance">$0.00</div>
                                        </div>
                                        <i class="fas fa-wallet fa-2x text-success"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="balancePercentage">+0% growth</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card border-left-info shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Interest Earned</div>
                                            <div class="h3 mb-0 text-gray-800" id="totalInterest">$0.00</div>
                                        </div>
                                        <i class="fas fa-coins fa-2x text-info"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="avgInterestRate">Average Rate: 0%</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card border-left-warning shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Avg Interest Rate</div>
                                            <div class="h3 mb-0 text-gray-800" id="avgRate">0%</div>
                                        </div>
                                        <i class="fas fa-percentage fa-2x text-warning"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="maturityStatus">All Active</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtering Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Filter by Status</label>
                                    <select class="form-select" id="depositStatusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="matured">Matured</option>
                                        <option value="withdrawn">Withdrawn</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Filter by Term</label>
                                    <select class="form-select" id="depositTermFilter">
                                        <option value="">All Terms</option>
                                        <option value="6">6 Months</option>
                                        <option value="12">1 Year</option>
                                        <option value="24">2 Years</option>
                                        <option value="36">3 Years</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Sort By</label>
                                    <select class="form-select" id="depositSort">
                                        <option value="date">Newest First</option>
                                        <option value="amount">Amount (High to Low)</option>
                                        <option value="balance">Balance (High to Low)</option>
                                        <option value="rate">Interest Rate (Highest)</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-3" onclick="filterAndSortDeposits()">Apply Filters</button>
                        </div>
                    </div>

                    <!-- Deposit Cards View -->
                    <div class="mb-4">
                        <h4 class="mb-3"><i class="fas fa-layer-group text-primary me-2"></i>Deposit Accounts</h4>
                        <div id="depositCardsContainer" class="row g-4">
                            <div class="col-12 text-center text-muted" id="noDepositsCard">
                                <p class="py-4">No deposits yet. Start saving today!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Deposit Table View -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-table text-primary me-2"></i>Deposit Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Principal Amount</th>
                                            <th>Current Balance</th>
                                            <th>Interest Rate</th>
                                            <th>Interest Earned</th>
                                            <th>Progress</th>
                                            <th>Maturity Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="depositTableBody">
                                        <tr id="noDepositsTable" class="text-center">
                                            <td colspan="8" class="text-muted py-4">No deposits found. Create your first deposit to get started.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Create New Deposit</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="depositForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Deposit Amount ($)</label>
                                <input type="number" class="form-control" id="newDepositAmount" placeholder="5000" min="100" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Interest Rate (% p.a.)</label>
                                <input type="number" class="form-control" id="newDepositRate" placeholder="3.5" min="0" max="10" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Deposit Term</label>
                                <select class="form-select" id="newDepositTerm" required>
                                    <option value="">Select Term...</option>
                                    <option value="6">6 Months</option>
                                    <option value="12">1 Year</option>
                                    <option value="24">2 Years</option>
                                    <option value="36">3 Years</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Deposit Type</label>
                                <select class="form-select" id="newDepositType" required>
                                    <option value="">Select Type...</option>
                                    <option value="savings">Savings Account</option>
                                    <option value="fixed">Fixed Deposit</option>
                                    <option value="recurring">Recurring Deposit</option>
                                    <option value="recurring_savings">Recurring Savings</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Additional Notes (Optional)</label>
                                <textarea class="form-control" id="newDepositNotes" placeholder="Enter any notes or preferences..." rows="2"></textarea>
                            </div>
                            <div class="col-12">
                                <div class="alert alert-info mb-0">
                                    <strong>Expected Maturity Value:</strong> <span id="expectedMaturityCalc" class="text-success fw-bold">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-check me-2"></i>Create Deposit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deposit Detail Modal -->
    <div class="modal fade" id="depositDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Deposit Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="depositDetailContent">
                        <!-- Content populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="withdrawDepositBtn" onclick="initiateWithdrawal()">
                        <i class="fas fa-sign-out-alt me-2"></i>Withdraw
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="modal fade" id="withdrawalModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title"><i class="fas fa-sign-out-alt me-2"></i>Withdraw from Deposit</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="withdrawalForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Current Balance</label>
                            <p id="withdrawalCurrentBalance" class="text-success fw-bold h5 mb-0">$0.00</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Withdrawal Amount ($)</label>
                            <input type="number" class="form-control" id="withdrawalAmount" placeholder="1000" min="1" step="0.01" required>
                            <small class="text-muted">You can withdraw via ATM, agent, or online transfer</small>
                        </div>
                        <div class="alert alert-info">
                            <strong>Note:</strong> Early withdrawal may have penalties depending on your deposit term and bank policies.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Process Withdrawal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-light footer mt-5 py-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-white mb-4">Address</h5>
                    <p class="mb-2"><i class="fa fa-map-marker-alt me-3"></i>123 Street, New York, USA</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/lib/wow/wow.min.js"></script>
    <script src="/static/lib/easing/easing.min.js"></script>
    <script src="/static/lib/waypoints/waypoints.min.js"></script>
    <script src="/static/lib/counterup/counterup.min.js"></script>
    <script src="/static/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/static/js/main.js"></script>
    <script src="/static/js/user-guard.js"></script>
    <script src="/static/js/realtime.js"></script>
    <script src="/static/js/page-sync.js"></script>
    <script>
        let allDeposits = [];
        let currentFilter = {
            status: '',
            term: '',
            sort: 'date'
        };
        let currentDepositId = null;

        // Load deposits from API
        async function loadDeposits() {
            try {
                const response = await fetch('/api/user/deposits', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load deposits');
                
                allDeposits = await response.json() || [];
                updateSummaryStats();
                filterAndSortDeposits();
                hideSpinner();
            } catch (error) {
                console.error('Error loading deposits:', error);
                showNoDeposits();
                hideSpinner();
            }
        }

        // Hide spinner
        function hideSpinner() {
            const spinner = document.getElementById('spinner');
            if (spinner) spinner.style.display = 'none';
        }

        // Update summary statistics
        function updateSummaryStats() {
            if (!allDeposits || allDeposits.length === 0) {
                document.getElementById('totalDeposits').textContent = '$0.00';
                document.getElementById('totalBalance').textContent = '$0.00';
                document.getElementById('totalInterest').textContent = '$0.00';
                document.getElementById('depositCount').textContent = '0 Active Deposits';
                document.getElementById('balancePercentage').textContent = '+0% growth';
                document.getElementById('avgInterestRate').textContent = 'Average Rate: 0%';
                document.getElementById('avgRate').textContent = '0%';
                return;
            }

            let totalDeposited = 0;
            let totalCurrentBalance = 0;
            let totalInterest = 0;
            let activeCount = 0;
            let totalRate = 0;
            let maturedCount = 0;

            allDeposits.forEach(dep => {
                const amount = dep.amount || 0;
                const balance = dep.current_balance || amount;
                const interest = (balance - amount);
                
                totalDeposited += amount;
                totalCurrentBalance += balance;
                totalInterest += interest;
                totalRate += (dep.interest_rate || 0);
                if (dep.status === 'active') activeCount++;
                if (dep.status === 'matured') maturedCount++;
            });

            const growthPercentage = totalDeposited > 0 ? ((totalCurrentBalance - totalDeposited) / totalDeposited * 100) : 0;
            const avgRate = allDeposits.length > 0 ? (totalRate / allDeposits.length) : 0;

            document.getElementById('totalDeposits').textContent = `$${totalDeposited.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalBalance').textContent = `$${totalCurrentBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalInterest').textContent = `$${totalInterest.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('depositCount').textContent = `${activeCount} Active Deposit${activeCount !== 1 ? 's' : ''}`;
            document.getElementById('balancePercentage').textContent = `${growthPercentage >= 0 ? '+' : ''}${growthPercentage.toFixed(2)}% growth`;
            document.getElementById('avgInterestRate').textContent = `Average Rate: ${avgRate.toFixed(2)}%`;
            document.getElementById('avgRate').textContent = `${avgRate.toFixed(2)}%`;
            document.getElementById('maturityStatus').textContent = `${maturedCount} Matured`;

            if (growthPercentage >= 0) {
                document.querySelector('#balancePercentage').className = 'small text-success mt-2';
            } else {
                document.querySelector('#balancePercentage').className = 'small text-danger mt-2';
            }
        }

        // Filter and sort deposits
        function filterAndSortDeposits() {
            currentFilter.status = document.getElementById('depositStatusFilter').value;
            currentFilter.term = document.getElementById('depositTermFilter').value;
            currentFilter.sort = document.getElementById('depositSort').value;

            let filtered = [...allDeposits];

            if (currentFilter.status) {
                filtered = filtered.filter(dep => (dep.status || 'active').toLowerCase() === currentFilter.status.toLowerCase());
            }
            if (currentFilter.term) {
                filtered = filtered.filter(dep => (dep.term_months || 0).toString() === currentFilter.term);
            }

            // Sort
            filtered.sort((a, b) => {
                switch(currentFilter.sort) {
                    case 'amount':
                        return (b.amount || 0) - (a.amount || 0);
                    case 'balance':
                        return (b.current_balance || 0) - (a.current_balance || 0);
                    case 'rate':
                        return (b.interest_rate || 0) - (a.interest_rate || 0);
                    case 'date':
                    default:
                        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                }
            });

            displayDeposits(filtered);
        }

        // Display deposits in cards and table
        function displayDeposits(deposits) {
            const cardsContainer = document.getElementById('depositCardsContainer');
            const tableBody = document.getElementById('depositTableBody');
            const noCardsMsg = document.getElementById('noDepositsCard');
            const noTableMsg = document.getElementById('noDepositsTable');

            // Clear existing
            cardsContainer.innerHTML = '';
            tableBody.innerHTML = '';

            if (!deposits || deposits.length === 0) {
                noCardsMsg.style.display = 'block';
                noTableMsg.style.display = '';
                return;
            }

            noCardsMsg.style.display = 'none';
            noTableMsg.style.display = 'none';

            // Display cards and table rows
            deposits.forEach(dep => {
                const card = createDepositCard(dep);
                cardsContainer.appendChild(card);

                const row = createDepositTableRow(dep);
                tableBody.appendChild(row);
            });
        }

        // Create deposit card
        function createDepositCard(dep) {
            const div = document.createElement('div');
            div.className = 'col-md-6 col-lg-4';
            
            const amount = dep.amount || 0;
            const balance = dep.current_balance || amount;
            const interest = balance - amount;
            const progress = amount > 0 ? (interest / (amount * 0.5)) * 100 : 0;
            const statusColor = {
                'active': 'success',
                'matured': 'warning',
                'withdrawn': 'danger'
            }[dep.status || 'active'] || 'secondary';

            const maturityDate = dep.maturity_date ? new Date(dep.maturity_date).toLocaleDateString() : 'N/A';

            div.innerHTML = `
                <div class="card h-100 shadow-sm border-0 cursor-pointer" style="transition: transform 0.2s; cursor: pointer;" 
                     onmouseover="this.style.transform='translateY(-5px)'" 
                     onmouseout="this.style.transform='translateY(0)'"
                     onclick="viewDepositDetail(${dep.id})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="card-title text-primary fw-bold mb-1">${formatDepositType(dep.deposit_type)}</h6>
                                <small class="text-muted">ID: ${dep.id}</small>
                            </div>
                            <span class="badge bg-${statusColor}">${(dep.status || 'active').charAt(0).toUpperCase() + (dep.status || 'active').slice(1)}</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Principal</small>
                                <strong>$${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <small class="text-muted">Current Balance</small>
                                <strong class="text-success">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Interest Rate</small>
                                <strong>${dep.interest_rate || 0}% p.a.</strong>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar" role="progressbar" style="width: ${Math.min(progress, 100)}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted mt-2">$${interest.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} earned</small>
                        </div>

                        <div class="row text-center text-sm">
                            <div class="col-6 border-end">
                                <small class="text-muted d-block">Term</small>
                                <strong>${dep.term_months || 'N/A'} mths</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Maturity</small>
                                <strong>${maturityDate.substring(0, 6)}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light border-top-0">
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="event.stopPropagation(); viewDepositDetail(${dep.id})">
                            <i class="fas fa-eye me-1"></i>View Details
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        // Create table row
        function createDepositTableRow(dep) {
            const tr = document.createElement('tr');
            const amount = dep.amount || 0;
            const balance = dep.current_balance || amount;
            const interest = balance - amount;
            const progress = amount > 0 ? (interest / (amount * 0.5)) * 100 : 0;
            const statusColor = {
                'active': 'success',
                'matured': 'warning',
                'withdrawn': 'danger'
            }[dep.status || 'active'] || 'secondary';

            const maturityDate = dep.maturity_date ? new Date(dep.maturity_date).toLocaleDateString() : 'N/A';

            tr.innerHTML = `
                <td class="fw-bold">$${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="text-success fw-bold">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${dep.interest_rate || 0}%</td>
                <td>$${interest.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>
                    <div class="progress" style="height: 20px; width: 100px;">
                        <div class="progress-bar" style="width: ${Math.min(progress, 100)}%;" role="progressbar" 
                             aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                            ${progress.toFixed(0)}%
                        </div>
                    </div>
                </td>
                <td>${maturityDate}</td>
                <td><span class="badge bg-${statusColor}">${(dep.status || 'active').charAt(0).toUpperCase() + (dep.status || 'active').slice(1)}</span></td>
                <td><button class="btn btn-sm btn-outline-primary" onclick="viewDepositDetail(${dep.id})"><i class="fas fa-eye"></i></button></td>
            `;
            return tr;
        }

        // Format deposit type
        function formatDepositType(type) {
            const types = {
                'savings': 'ðŸ’° Savings Account',
                'fixed': 'ðŸ“Œ Fixed Deposit',
                'recurring': 'ðŸ“ˆ Recurring Deposit',
                'recurring_savings': 'ðŸ”„ Recurring Savings'
            };
            return types[type?.toLowerCase()] || type || 'Savings';
        }

        // View deposit detail
        function viewDepositDetail(depositId) {
            const dep = allDeposits.find(d => d.id === depositId);
            if (!dep) return;

            currentDepositId = depositId;
            const amount = dep.amount || 0;
            const balance = dep.current_balance || amount;
            const interest = balance - amount;
            const progress = amount > 0 ? (interest / (amount * 0.5)) * 100 : 0;

            const detailContent = document.getElementById('depositDetailContent');
            const maturityDate = dep.maturity_date ? new Date(dep.maturity_date).toLocaleDateString() : 'N/A';
            const createdDate = dep.created_at ? new Date(dep.created_at).toLocaleDateString() : 'N/A';

            detailContent.innerHTML = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="mb-3">${formatDepositType(dep.deposit_type)}</h5>
                        <div class="alert alert-info">
                            <strong>Deposit Status:</strong> <span class="badge bg-info">${(dep.status || 'active').toUpperCase()}</span>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Principal Amount</h6>
                        <h4 class="text-primary">$${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Current Balance</h6>
                        <h4 class="text-success">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Interest Earned</h6>
                        <h4 class="text-info">$${interest.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Interest Rate</h6>
                        <h4 class="text-warning">${dep.interest_rate || 0}% p.a.</h4>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="text-muted text-uppercase mb-3">Interest Accumulation Progress</h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" style="width: ${Math.min(progress, 100)}%;" role="progressbar" 
                             aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                            ${progress.toFixed(1)}% Progress
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 border-end">
                        <h6 class="text-muted text-uppercase mb-2">Term</h6>
                        <p class="mb-0"><strong>${dep.term_months || 'N/A'} Months</strong></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Deposit Type</h6>
                        <p class="mb-0"><strong>${formatDepositType(dep.deposit_type)}</strong></p>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 border-end">
                        <h6 class="text-muted text-uppercase mb-2">Created Date</h6>
                        <p class="mb-0"><strong>${createdDate}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Maturity Date</h6>
                        <p class="mb-0"><strong>${maturityDate}</strong></p>
                    </div>
                </div>

                ${dep.notes ? `<div class="alert alert-light"><strong>Notes:</strong> ${dep.notes}</div>` : ''}
            `;

            const modal = new bootstrap.Modal(document.getElementById('depositDetailModal'));
            modal.show();
        }

        // Initiate withdrawal
        function initiateWithdrawal() {
            if (!currentDepositId) return;
            
            const dep = allDeposits.find(d => d.id === currentDepositId);
            if (!dep) return;

            const balance = dep.current_balance || dep.amount;
            document.getElementById('withdrawalCurrentBalance').textContent = `$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('withdrawalAmount').max = balance;
            document.getElementById('withdrawalAmount').value = '';

            const detailModal = bootstrap.Modal.getInstance(document.getElementById('depositDetailModal'));
            if (detailModal) detailModal.hide();

            const withdrawalModal = new bootstrap.Modal(document.getElementById('withdrawalModal'));
            withdrawalModal.show();
        }

        // Show no deposits message
        function showNoDeposits() {
            document.getElementById('noDepositsCard').style.display = 'block';
            document.getElementById('noDepositsTable').style.display = '';
        }

        // Calculate expected maturity value
        function calculateExpectedMaturity() {
            const amount = parseFloat(document.getElementById('newDepositAmount').value) || 0;
            const rate = parseFloat(document.getElementById('newDepositRate').value) || 0;
            const term = parseFloat(document.getElementById('newDepositTerm').value) || 0;
            
            if (amount && rate && term) {
                const years = term / 12;
                const expectedValue = amount * Math.pow(1 + (rate / 100), years);
                document.getElementById('expectedMaturityCalc').textContent = 
                    `$${expectedValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
        }

        // Update expected value on input
        ['newDepositAmount', 'newDepositRate', 'newDepositTerm'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', calculateExpectedMaturity);
        });

        // Setup form event listeners
        function setupDepositEventListeners() {
            const depositForm = document.getElementById('depositForm');
            const withdrawalForm = document.getElementById('withdrawalForm');

            if (depositForm) {
                depositForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const depositData = {
                        amount: parseFloat(document.getElementById('newDepositAmount').value),
                        interest_rate: parseFloat(document.getElementById('newDepositRate').value),
                        term_months: parseInt(document.getElementById('newDepositTerm').value),
                        deposit_type: document.getElementById('newDepositType').value,
                        notes: document.getElementById('newDepositNotes').value
                    };

                    try {
                        const response = await fetch('/api/user/deposits', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(depositData),
                            credentials: 'include'
                        });

                        if (!response.ok) throw new Error('Failed to create deposit');
                        
                        const newDeposit = await response.json();
                        allDeposits.push(newDeposit);
                        
                        depositForm.reset();
                        const modal = bootstrap.Modal.getInstance(document.getElementById('depositModal'));
                        if (modal) modal.hide();
                        
                        updateSummaryStats();
                        filterAndSortDeposits();
                        
                        alert('Deposit created successfully!');
                    } catch (error) {
                        alert('Error: ' + error.message);
                    }
                });
            }

            if (withdrawalForm) {
                withdrawalForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (!currentDepositId) return;

                    const withdrawalData = {
                        amount: parseFloat(document.getElementById('withdrawalAmount').value)
                    };

                    try {
                        const response = await fetch(`/api/user/deposits/${currentDepositId}/withdraw`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(withdrawalData),
                            credentials: 'include'
                        });

                        if (!response.ok) throw new Error('Withdrawal failed');
                        
                        const result = await response.json();
                        alert(`Withdrawal successful!\nNew Balance: $${result.new_balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                        
                        const withdrawalModal = bootstrap.Modal.getInstance(document.getElementById('withdrawalModal'));
                        if (withdrawalModal) withdrawalModal.hide();
                        
                        document.getElementById('withdrawalForm').reset();
                        loadDeposits();
                    } catch (error) {
                        alert('Error: ' + error.message);
                    }
                });
            }
        }

        // Auto-refresh deposits every 30 seconds
        let autoRefreshInterval;
        
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                console.log('[DEPOSITS] Auto-refreshing deposits...');
                loadDeposits();
            }, 30000); // 30 seconds
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }
        
        // Load deposits on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupDepositEventListeners();
                loadDeposits();
                startAutoRefresh();
            });
        } else {
            setupDepositEventListeners();
            loadDeposits();
            startAutoRefresh();
        }
        
        // Stop auto-refresh when leaving the page
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>

    <style>
        .border-left-primary {
            border-left: 4px solid #0d6efd;
        }
        .border-left-success {
            border-left: 4px solid #28a745;
        }
        .border-left-info {
            border-left: 4px solid #17a2b8;
        }
        .border-left-warning {
            border-left: 4px solid #ffc107;
        }
        .text-xs {
            font-size: 0.75rem;
        }
        .text-gray-800 {
            color: #2e3338;
        }
        .shadow {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .shadow-sm {
            box-shadow: 0 0.1rem 0.3rem 0 rgba(0, 0, 0, 0.1);
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .card {
            border: 1px solid #e3e6f0;
        }
        .card-header {
            border-bottom: 1px solid #e3e6f0;
        }
        .progress {
            background-color: #e3e6f0;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .badge {
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
        }
    </style>
</body>

</html>