<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Transfers - Finanza</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .scheduled-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .schedule-card { border-left: 4px solid #667eea; transition: all 0.3s; }
        .schedule-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .frequency-badge { font-size: 11px; text-transform: uppercase; font-weight: 600; }
        .status-active { background: #d4edda; color: #155724; }
        .status-paused { background: #fff3cd; color: #856404; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/user/dashboard">
                <i class="fas fa-calendar-alt"></i> Scheduled Transfers
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="servicesDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-concierge-bell"></i> Services
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/user/bill_pay">One-Time</a></li>
                            <li><a class="dropdown-item active" href="/user/scheduled_transfers">Scheduled</a></li>
                            <li><a class="dropdown-item" href="/user/bill_pay">Bill Pay</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-5 mb-5">
        <!-- Header -->
        <div class="scheduled-header">
            <h1><i class="fas fa-calendar-alt"></i> Scheduled Transfers</h1>
            <p class="mb-0">Automate your recurring payments and transfers</p>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Active Schedules</h6>
                        <h2 id="activeSchedules">-</h2>
                        <p class="text-muted mb-0">Running</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Monthly Recurring</h6>
                        <h2 id="monthlyAmount">$-</h2>
                        <p class="text-muted mb-0">Automatically scheduled</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Next Transfer</h6>
                        <h2 id="nextTransferDate">-</h2>
                        <p class="text-muted mb-0" id="nextAmount">Amount: $-</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Total Saved</h6>
                        <h2 id="totalSaved">$-</h2>
                        <p class="text-muted mb-0">By automating</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Schedule -->
        <div class="card mb-5">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Create Scheduled Transfer</h5>
            </div>
            <div class="card-body">
                <form id="scheduleForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Transfer Name</label>
                            <input type="text" class="form-control" id="scheduleName" placeholder="e.g., Rent Payment" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Description (Optional)</label>
                            <input type="text" class="form-control" id="scheduleDescription" placeholder="Add notes">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">From Account</label>
                            <select class="form-control" id="fromAccount" required>
                                <option value="">Select account</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Recipient</label>
                            <input type="text" class="form-control" id="recipient" placeholder="Recipient name/account" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="amount" step="0.01" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Frequency</label>
                            <select class="form-control" id="frequency" required>
                                <option value="">Select frequency</option>
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="annual">Annual</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date (Optional)</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoReplenish" checked>
                                <label class="form-check-label" for="autoReplenish">
                                    Auto-replenish account if low balance
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save"></i> Create Schedule</button>
                </form>
            </div>
        </div>

        <!-- Active Schedules -->
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> Active Schedules</h5>
            </div>
            <div class="card-body">
                <div id="activeSchedulesContainer">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Schedule History -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Transfer History</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Schedule</th>
                                <th>Recipient</th>
                                <th>Amount</th>
                                <th>Frequency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const token = localStorage.getItem('token');

        document.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                window.location.href = '/signin';
                return;
            }

            try {
                await loadScheduleStats();
                await loadAccounts();
                await loadActiveSchedules();
                await loadTransferHistory();
            } catch (error) {
                console.error('Error loading data:', error);
            }

            document.getElementById('scheduleForm').addEventListener('submit', handleCreateSchedule);
        });

        async function loadScheduleStats() {
            try {
                const response = await fetch('/api/v1/scheduled_transfers/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('activeSchedules').textContent = data.active_count || '0';
                    document.getElementById('monthlyAmount').textContent = '$' + (data.monthly_amount || 0).toLocaleString('en-US', {maximumFractionDigits: 2});
                    document.getElementById('nextTransferDate').textContent = data.next_date || '-';
                    document.getElementById('nextAmount').textContent = 'Amount: $' + (data.next_amount || 0).toLocaleString('en-US', {maximumFractionDigits: 2});
                    document.getElementById('totalSaved').textContent = '$' + (data.total_saved || 0).toLocaleString('en-US', {maximumFractionDigits: 2});
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadAccounts() {
            try {
                const response = await fetch('/api/v1/accounts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('fromAccount');
                    select.innerHTML = '<option value="">Select account</option>';
                    
                    if (data.accounts && data.accounts.length > 0) {
                        data.accounts.forEach(account => {
                            select.innerHTML += `<option value="${account.id}">${account.name} - $${account.balance.toLocaleString('en-US', {maximumFractionDigits: 2})}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        async function loadActiveSchedules() {
            try {
                const response = await fetch('/api/v1/scheduled_transfers/active', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('activeSchedulesContainer');
                    container.innerHTML = '';

                    if (data.schedules && data.schedules.length > 0) {
                        data.schedules.forEach(schedule => {
                            container.innerHTML += `
                                <div class="card schedule-card mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="card-title">${schedule.name}</h6>
                                                <p class="text-muted small">To: ${schedule.recipient}</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p class="mb-1"><strong>$${schedule.amount.toLocaleString('en-US', {maximumFractionDigits: 2})}</strong></p>
                                                <span class="frequency-badge badge bg-info">${schedule.frequency}</span>
                                            </div>
                                            <div class="col-md-3 text-end">
                                                <p class="mb-1"><span class="badge ${schedule.status === 'active' ? 'bg-success' : 'bg-warning'}">${schedule.status.toUpperCase()}</span></p>
                                                <p class="small text-muted">Next: ${schedule.next_date}</p>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editSchedule('${schedule.id}')">Edit</button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="pauseSchedule('${schedule.id}')">Pause</button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule('${schedule.id}')">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        container.innerHTML = '<div class="text-center text-muted">No active schedules</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }

        async function loadTransferHistory() {
            try {
                const response = await fetch('/api/v1/scheduled_transfers/history?limit=20', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('historyBody');
                    tbody.innerHTML = '';

                    if (data.transfers && data.transfers.length > 0) {
                        data.transfers.forEach(transfer => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${new Date(transfer.date).toLocaleDateString()}</td>
                                    <td>${transfer.schedule_name}</td>
                                    <td>${transfer.recipient}</td>
                                    <td>$${transfer.amount.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                    <td><span class="frequency-badge badge bg-secondary">${transfer.frequency}</span></td>
                                    <td><span class="badge bg-success">${transfer.status}</span></td>
                                    <td><button class="btn btn-sm btn-outline-primary">View</button></td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transfer history</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function handleCreateSchedule(e) {
            e.preventDefault();

            const schedule = {
                name: document.getElementById('scheduleName').value,
                description: document.getElementById('scheduleDescription').value,
                from_account_id: document.getElementById('fromAccount').value,
                recipient: document.getElementById('recipient').value,
                amount: parseFloat(document.getElementById('amount').value),
                frequency: document.getElementById('frequency').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                auto_replenish: document.getElementById('autoReplenish').checked
            };

            try {
                const response = await fetch('/api/v1/scheduled_transfers/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(schedule)
                });

                if (response.ok) {
                    alert('Schedule created successfully!');
                    document.getElementById('scheduleForm').reset();
                    await loadScheduleStats();
                    await loadActiveSchedules();
                } else {
                    alert('Error creating schedule');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating schedule');
            }
        }

        function editSchedule(id) {
            alert('Edit schedule: ' + id);
        }

        function pauseSchedule(id) {
            alert('Pause schedule: ' + id);
        }

        function deleteSchedule(id) {
            if (confirm('Are you sure you want to delete this schedule?')) {
                alert('Delete schedule: ' + id);
            }
        }
    </script>
</body>
</html>
