<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanza - Admin Dashboard Hub</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .admin-nav { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0; }
        .dashboard-card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; position: relative; border-left: 4px solid transparent; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .dashboard-card i { font-size: 40px; margin-bottom: 15px; }
        .dashboard-card h5 { color: #333; font-weight: 600; margin: 10px 0; }
        .dashboard-card p { color: #666; font-size: 0.9rem; margin: 0; }
        .dashboard-card small { display: block; margin-top: 10px; }
        .badge-count { position: absolute; top: 10px; right: 10px; background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }
        .stats-bar { background: white; border-radius: 10px; padding: 20px; margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9rem; margin-top: 5px; }
        .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .card-icon { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        .users-icon { background: #e3f2fd; color: #2196f3; }
        .kyc-icon { background: #f3e5f5; color: #9c27b0; }
        .transactions-icon { background: #e8f5e9; color: #4caf50; }
        .deposits-icon { background: #fff3e0; color: #ff9800; }
        .reports-icon { background: #fce4ec; color: #e91e63; }
        .settings-icon { background: #f0f4c3; color: #8bc34a; }
        .lending-icon { background: #fce4ec; color: #d81b60; }
        .settlement-icon { background: #e0f2f1; color: #00897b; }
        .fraud-icon { background: #ffebee; color: #c62828; }
        .compliance-icon { background: #f3e5f5; color: #6a1b9a; }
        .treasury-icon { background: #e8f5e9; color: #2e7d32; }
        .blockchain-icon { background: #f1f8e9; color: #558b2f; }
        .webhook-icon { background: #ede7f6; color: #512da8; }
        .monitoring-icon { background: #fff3e0; color: #e65100; }
        .section-header { font-size: 1.3rem; font-weight: 700; color: #333; margin-top: 30px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #667eea; }
    </style>
</head>
<body>
    <nav class="admin-nav navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/user/admin/dashboard"><i class="fas fa-chart-line"></i> Finanza Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarAdmin">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarAdmin">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-5">
        <div class="admin-header">
            <h1><i class="fas fa-crown"></i> Admin Control Center</h1>
            <p class="mb-0">Manage users, transactions, KYC submissions, and system settings</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pendingKYC">-</div>
                <div class="stat-label">Pending KYC</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalTransactions">-</div>
                <div class="stat-label">Total Transactions</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalDeposits">-</div>
                <div class="stat-label">Total Deposits</div>
            </div>
        </div>

        <h3 class="mt-5 mb-4"><i class="fas fa-th-large"></i> Admin Modules</h3>
        <div class="dashboard-grid">
            <!-- Core Operations -->
            <!-- User Management -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/users')">
                <div class="card-icon users-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h5>User Management</h5>
                <p>Create, view, and manage user accounts</p>
                <small class="text-muted">User CRUD operations</small>
            </div>

            <!-- KYC Management -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/kyc')">
                <div class="card-icon kyc-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h5>KYC Management</h5>
                <p>Review and approve KYC submissions</p>
                <small class="text-muted">Document verification</small>
            </div>

            <!-- Transaction Management -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/transactions')">
                <div class="card-icon transactions-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <h5>Transactions</h5>
                <p>Monitor and manage all transactions</p>
                <small class="text-muted">Transaction tracking & disputes</small>
            </div>

            <!-- Account Funding -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/fund')">
                <div class="card-icon deposits-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <h5>Fund Accounts</h5>
                <p>Fund user accounts and adjust balances</p>
                <small class="text-muted">Account operations</small>
            </div>

            <!-- Settlement Management -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/settlement')">
                <div class="card-icon settlement-icon">
                    <i class="fas fa-handshake"></i>
                </div>
                <h5>Settlement Management</h5>
                <p>Manage settlement cycles and reconciliation</p>
                <small class="text-muted">ACH, Wire, RTP, FedNow</small>
            </div>

            <!-- Mobile Deposits -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/mobile_deposit')">
                <div class="card-icon deposits-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <h5>Mobile Deposits</h5>
                <p>Process and verify mobile check deposits</p>
                <small class="text-muted">Image verification & checks</small>
            </div>
        </div>

        <!-- Lending & Loans Section -->
        <div class="section-header">
            <i class="fas fa-credit-card"></i> Lending Services
        </div>
        <div class="dashboard-grid">
            <!-- Loan Management -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/lending')">
                <div class="card-icon lending-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <h5>Loan Management</h5>
                <p>Manage loan portfolio and payments</p>
                <small class="text-muted">Payments, schedules, modifications</small>
            </div>

            <!-- Lending Compliance -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/lending_compliance')">
                <div class="card-icon compliance-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h5>Lending Compliance</h5>
                <p>Collections, holds, and delinquency tracking</p>
                <small class="text-muted">Collections & forbearance</small>
            </div>

            <!-- HMDA Compliance -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/hmda')">
                <div class="card-icon compliance-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h5>HMDA Compliance</h5>
                <p>Fair lending and regulatory reporting</p>
                <small class="text-muted">HMDA applications & submissions</small>
            </div>

            <!-- ACH Management -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/ach_management')">
                <div class="card-icon settlement-icon">
                    <i class="fas fa-stream"></i>
                </div>
                <h5>ACH Management</h5>
                <p>ACH files, returns, and NSF management</p>
                <small class="text-muted">ACH processing & reconciliation</small>
            </div>
        </div>

        <!-- Compliance & Risk Section -->
        <div class="section-header">
            <i class="fas fa-lock"></i> Compliance & Risk Management
        </div>
        <div class="dashboard-grid">
            <!-- Fraud Detection -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/fraud_detection')">
                <div class="card-icon fraud-icon">
                    <i class="fas fa-bug"></i>
                </div>
                <h5>Fraud Detection</h5>
                <p>Advanced fraud detection and prevention</p>
                <small class="text-muted">Scoring, monitoring, blocked transactions</small>
            </div>

            <!-- International Compliance -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/international_compliance')">
                <div class="card-icon compliance-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <h5>International Compliance</h5>
                <p>Global compliance and risk assessment</p>
                <small class="text-muted">Sanctions screening & country risk</small>
            </div>

            <!-- Bill Pay -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/bill_pay')">
                <div class="card-icon transactions-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <h5>Bill Pay Management</h5>
                <p>Manage bill payments and exceptions</p>
                <small class="text-muted">Payments, templates, payees</small>
            </div>

            <!-- Webhooks -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/webhooks')">
                <div class="card-icon webhook-icon">
                    <i class="fas fa-plug"></i>
                </div>
                <h5>Webhooks Management</h5>
                <p>Event routing and delivery tracking</p>
                <small class="text-muted">Subscriptions, delivery logs</small>
            </div>
        </div>

        <!-- Treasury & Investment Section -->
        <div class="section-header">
            <i class="fas fa-piggy-bank"></i> Treasury & Investment
        </div>
        <div class="dashboard-grid">
            <!-- Treasury Management -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/treasury')">
                <div class="card-icon treasury-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h5>Treasury Management</h5>
                <p>Portfolio allocation and rebalancing</p>
                <small class="text-muted">Assets, strategies, liquidity</small>
            </div>

            <!-- Currency Exchange -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/currency_exchange')">
                <div class="card-icon treasury-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <h5>Currency Exchange</h5>
                <p>Manage FX rates and volumes</p>
                <small class="text-muted">Rates, fees, analytics</small>
            </div>

            <!-- Blockchain Assets -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/blockchain')">
                <div class="card-icon blockchain-icon">
                    <i class="fas fa-link"></i>
                </div>
                <h5>Blockchain Assets</h5>
                <p>Manage blockchain integrations</p>
                <small class="text-muted">Crypto, wallets, transactions</small>
            </div>
        </div>

        <!-- Analytics & Monitoring Section -->
        <div class="section-header">
            <i class="fas fa-chart-bar"></i> Analytics & Monitoring
        </div>
        <div class="dashboard-grid">
            <!-- Reports & Analytics -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/reporting')">
                <div class="card-icon reports-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <h5>Reports & Analytics</h5>
                <p>Comprehensive business analytics</p>
                <small class="text-muted">Data insights & exports</small>
            </div>

            <!-- System Monitoring -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/monitoring')">
                <div class="card-icon monitoring-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h5>System Monitoring</h5>
                <p>Health checks and performance metrics</p>
                <small class="text-muted">Services, database, alerts</small>
            </div>

            <!-- Settings -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/settings')">
                <div class="card-icon settings-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h5>System Settings</h5>
                <p>Configure admin settings and preferences</p>
                <small class="text-muted">System configuration</small>
            </div>

            <!-- Admin Profile -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/profile')">
                <div class="card-icon settings-icon">
                    <i class="fas fa-user-circle"></i>
                </div>
                <h5>Admin Profile</h5>
                <p>Manage your admin account and credentials</p>
                <small class="text-muted">Account settings & security</small>
            </div>

            <!-- Reports Dashboard -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/reports')">
                <div class="card-icon reports-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <h5>Reports Dashboard</h5>
                <p>Pre-built reports and dashboards</p>
                <small class="text-muted">Reports, exports & templates</small>
            </div>
        </div>

        <!-- Utility & Tools Section -->
        <div class="section-header">
            <i class="fas fa-tools"></i> Utility & Administration
        </div>
        <div class="dashboard-grid">
            <!-- Admin Profile (Alternative location) -->
            <div class="dashboard-card" onclick="navigateTo('/user/admin/profile')">
                <div class="card-icon settings-icon">
                    <i class="fas fa-id-card"></i>
                </div>
                <h5>Admin Account</h5>
                <p>Profile, security, and preferences</p>
                <small class="text-muted">Credentials & 2FA settings</small>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-lg-6">
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h5><i class="fas fa-tasks"></i> Quick Actions</h5>
                    <ul class="list-unstyled mt-3">
                        <li><a href="#" onclick="openModal('fundUserModal')" class="btn btn-sm btn-primary mb-2"><i class="fas fa-plus"></i> Create User</a></li>
                        <li><a href="#" onclick="openModal('adjustBalanceModal')" class="btn btn-sm btn-info mb-2"><i class="fas fa-wallet"></i> Adjust Balance</a></li>
                        <li><a href="/user/admin/kyc" class="btn btn-sm btn-warning mb-2"><i class="fas fa-check"></i> Review KYC</a></li>
                        <li><a href="#" onclick="generateReport()" class="btn btn-sm btn-success"><i class="fas fa-download"></i> Generate Report</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-6">
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h5><i class="fas fa-bell"></i> Recent Activity</h5>
                    <div id="activityLog" style="max-height: 250px; overflow-y: auto;">
                        <p class="text-muted">Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin_static/js/auth-helper.js"></script>
    <script>
        const API_BASE = '/api/admin/data';

        async function loadDashboardStats() {
            try {
                console.log('=== Dashboard Init ===');
                console.log('Cookie string:', document.cookie);
                
                const headers = {
                    'Content-Type': 'application/json'
                };

                console.log('Making API calls with credentials...');

                // Load all stats in parallel with error handling
                const results = await Promise.allSettled([
                    fetch(API_BASE + '/users', { headers, credentials: 'include' }).then(async r => {
                        console.log('Users response status:', r.status);
                        const text = await r.text();
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
                        return JSON.parse(text);
                    }),
                    fetch(API_BASE + '/kyc', { headers, credentials: 'include' }).then(async r => {
                        console.log('KYC response status:', r.status);
                        const text = await r.text();
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
                        return JSON.parse(text);
                    }),
                    fetch(API_BASE + '/transactions', { headers, credentials: 'include' }).then(async r => {
                        console.log('Transactions response status:', r.status);
                        const text = await r.text();
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
                        return JSON.parse(text);
                    }),
                    fetch(API_BASE + '/deposits', { headers, credentials: 'include' }).then(async r => {
                        console.log('Deposits response status:', r.status);
                        const text = await r.text();
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
                        return JSON.parse(text);
                    })
                ]);

                console.log('API results:', results);

                // Process users
                if (results[0].status === 'fulfilled') {
                    const usersData = results[0].value;
                    const userCount = usersData.data ? usersData.data.length : 0;
                    document.getElementById('totalUsers').textContent = userCount;
                    console.log('Users loaded:', userCount);
                } else {
                    console.error('Users error:', results[0].reason);
                    document.getElementById('totalUsers').textContent = 'N/A';
                }

                // Process KYC
                if (results[1].status === 'fulfilled') {
                    const kycData = results[1].value;
                    const pendingCount = kycData.data ? kycData.data.filter(k => k.status === 'pending').length : 0;
                    document.getElementById('pendingKYC').textContent = pendingCount;
                    console.log('KYC loaded, pending:', pendingCount);
                } else {
                    console.error('KYC error:', results[1].reason);
                    document.getElementById('pendingKYC').textContent = 'N/A';
                }

                // Process transactions
                if (results[2].status === 'fulfilled') {
                    const txData = results[2].value;
                    const txCount = txData.data ? txData.data.length : 0;
                    document.getElementById('totalTransactions').textContent = txCount;
                    console.log('Transactions loaded:', txCount);
                } else {
                    console.error('Transactions error:', results[2].reason);
                    document.getElementById('totalTransactions').textContent = 'N/A';
                }

                // Process deposits
                if (results[3].status === 'fulfilled') {
                    const depositsData = results[3].value;
                    const depositCount = depositsData.data ? depositsData.data.length : 0;
                    document.getElementById('totalDeposits').textContent = depositCount;
                    console.log('Deposits loaded:', depositCount);
                } else {
                    console.error('Deposits error:', results[3].reason);
                    document.getElementById('totalDeposits').textContent = 'N/A';
                }

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('pendingKYC').textContent = 'Error';
                document.getElementById('totalTransactions').textContent = 'Error';
                document.getElementById('totalDeposits').textContent = 'Error';
            }
        }

        function navigateTo(path) {
            window.location.href = path;
        }

        function loadActivityLog() {
            const logContainer = document.getElementById('activityLog');
            logContainer.innerHTML = `
                <div class="text-muted">
                    <small>No recent activity logged</small>
                </div>
            `;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('Dashboard page loaded, initializing...');
            loadDashboardStats();
            loadActivityLog();
        });
    </script>
    <script src="/static/js/admin-guard.js"></script>
</body>
</html>
