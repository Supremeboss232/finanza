<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Exchange - Finanza</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        .exchange-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .exchange-card { border-top: 3px solid #f5576c; transition: all 0.3s; }
        .exchange-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .currency-badge { font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .rate-change-up { color: #28a745; }
        .rate-change-down { color: #dc3545; }
        #exchangeRateChart { max-height: 300px; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/user/dashboard">
                <i class="fas fa-exchange-alt"></i> Currency Exchange
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="servicesDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-concierge-bell"></i> Services
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/user/bill_pay">Bill Pay</a></li>
                            <li><a class="dropdown-item active" href="/user/currency_exchange">Currency Exchange</a></li>
                            <li><a class="dropdown-item" href="/user/international_transfers">International</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-5 mb-5">
        <!-- Header -->
        <div class="exchange-header">
            <h1><i class="fas fa-exchange-alt"></i> Currency Exchange</h1>
            <p class="mb-0">Trade currencies at competitive rates</p>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="card exchange-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Available Currencies</h6>
                        <h2 id="currencyCount">-</h2>
                        <p class="text-muted mb-0">Top rates updated live</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card exchange-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Total Exchanged</h6>
                        <h2 id="totalExchanged">$-</h2>
                        <p class="text-muted mb-0">This month</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card exchange-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Pending Trades</h6>
                        <h2 id="pendingTrades">-</h2>
                        <p class="text-muted mb-0">In progress</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card exchange-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Best Rate Today</h6>
                        <h2 id="bestRate">-</h2>
                        <p class="text-muted mb-0" id="bestRatePair">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exchange Calculator -->
        <div class="card mb-5">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> Exchange Calculator</h5>
            </div>
            <div class="card-body">
                <form id="exchangeForm">
                    <div class="row mb-4">
                        <div class="col-md-5">
                            <label class="form-label">Amount to Convert</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text" id="fromCurrencyLabel">USD</span>
                                <input type="number" class="form-control" id="fromAmount" placeholder="0.00" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-secondary w-100 mb-2" id="swapBtn">
                                <i class="fas fa-arrow-right-arrow-left"></i>
                            </button>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">You Will Receive</label>
                            <div class="input-group input-group-lg">
                                <input type="number" class="form-control" id="toAmount" placeholder="0.00" readonly>
                                <span class="input-group-text" id="toCurrencyLabel">EUR</span>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-5">
                            <label class="form-label">From Currency</label>
                            <select class="form-control form-control-lg" id="fromCurrency" required>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                            </select>
                        </div>
                        <div class="col-md-1"></div>
                        <div class="col-md-5">
                            <label class="form-label">To Currency</label>
                            <select class="form-control form-control-lg" id="toCurrency" required>
                                <option value="EUR">EUR - Euro</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-4 p-3 bg-light rounded">
                        <div class="col-md-4">
                            <strong>Exchange Rate</strong><br>
                            <h5 id="exchangeRate">1 USD = - EUR</h5>
                        </div>
                        <div class="col-md-4">
                            <strong>Fee (0.5%)</strong><br>
                            <h5 id="exchangeFee">$-</h5>
                        </div>
                        <div class="col-md-4">
                            <strong>Net Amount</strong><br>
                            <h5 id="netAmount">$-</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">From Account</label>
                            <select class="form-control" id="fromAccount" required>
                                <option value="">Select account</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">To Account</label>
                            <select class="form-control" id="toAccount" required>
                                <option value="">Select account</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-check"></i> Confirm Exchange
                    </button>
                </form>
            </div>
        </div>

        <!-- Exchange Rate Chart -->
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Exchange Rate Trend (24h)</h5>
            </div>
            <div class="card-body">
                <canvas id="exchangeRateChart"></canvas>
            </div>
        </div>

        <!-- Live Rates -->
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Live Exchange Rates (vs USD)</h5>
            </div>
            <div class="card-body">
                <div class="row g-3" id="ratesContainer">
                    <div class="col-12 text-center text-muted">Loading rates...</div>
                </div>
            </div>
        </div>

        <!-- Recent Exchanges -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Exchanges</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Rate</th>
                                <th>Amount</th>
                                <th>Fee</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentExchangesBody">
                            <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let chart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                window.location.href = '/signin';
                return;
            }

            try {
                await loadExchangeStats();
                await loadAccounts();
                await loadLiveRates();
                await loadRecentExchanges();
                await loadExchangeChart();
                setupEventListeners();
            } catch (error) {
                console.error('Error loading exchange data:', error);
            }
        });

        function setupEventListeners() {
            document.getElementById('fromAmount').addEventListener('input', updateConversion);
            document.getElementById('fromCurrency').addEventListener('change', updateConversion);
            document.getElementById('toCurrency').addEventListener('change', updateConversion);
            
            document.getElementById('swapBtn').addEventListener('click', swapCurrencies);
            document.getElementById('exchangeForm').addEventListener('submit', handleExchange);
        }

        async function loadExchangeStats() {
            try {
                const response = await fetch('/api/v1/currency_exchange/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('currencyCount').textContent = data.total_currencies || '0';
                    document.getElementById('totalExchanged').textContent = '$' + (data.total_exchanged || 0).toLocaleString();
                    document.getElementById('pendingTrades').textContent = data.pending_trades || '0';
                    document.getElementById('bestRate').textContent = (data.best_rate || 0).toFixed(4);
                    document.getElementById('bestRatePair').textContent = data.best_rate_pair || '-';
                }
            } catch (error) {
                console.error('Error loading exchange stats:', error);
            }
        }

        async function loadAccounts() {
            try {
                const response = await fetch('/api/v1/accounts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const fromSelect = document.getElementById('fromAccount');
                    const toSelect = document.getElementById('toAccount');
                    
                    fromSelect.innerHTML = '<option value="">Select account</option>';
                    toSelect.innerHTML = '<option value="">Select account</option>';
                    
                    if (data.accounts && data.accounts.length > 0) {
                        data.accounts.forEach(account => {
                            const option = `<option value="${account.id}">${account.name} - ${account.currency || 'USD'}</option>`;
                            fromSelect.innerHTML += option;
                            toSelect.innerHTML += option;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        async function loadLiveRates() {
            try {
                const response = await fetch('/api/v1/currency_exchange/rates', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('ratesContainer');
                    container.innerHTML = '';

                    if (data.rates && Object.keys(data.rates).length > 0) {
                        Object.entries(data.rates).forEach(([pair, rate]) => {
                            const change = Math.random() > 0.5 ? '+0.23%' : '-0.12%';
                            const changeClass = change.includes('+') ? 'rate-change-up' : 'rate-change-down';
                            
                            container.innerHTML += `
                                <div class="col-md-6 col-lg-4">
                                    <div class="card exchange-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="card-title mb-1">${pair}</h6>
                                                    <p class="text-muted small mb-0">Exchange rate</p>
                                                </div>
                                                <span class="badge bg-primary">${rate.toFixed(4)}</span>
                                            </div>
                                            <p class="text-muted small mt-2 mb-0">24h change: <span class="${changeClass}">${change}</span></p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading live rates:', error);
            }
        }

        async function loadRecentExchanges() {
            try {
                const response = await fetch('/api/v1/currency_exchange/history', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('recentExchangesBody');
                    tbody.innerHTML = '';

                    if (data.exchanges && data.exchanges.length > 0) {
                        data.exchanges.forEach(ex => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${new Date(ex.date).toLocaleDateString()}</td>
                                    <td><span class="currency-badge">${ex.from_currency}</span></td>
                                    <td><span class="currency-badge">${ex.to_currency}</span></td>
                                    <td>${ex.rate.toFixed(4)}</td>
                                    <td>${ex.amount.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                    <td>${ex.fee.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                    <td><span class="badge bg-success">${ex.status}</span></td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No exchanges yet</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading exchanges:', error);
            }
        }

        async function loadExchangeChart() {
            try {
                const response = await fetch('/api/v1/currency_exchange/chart-data', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const ctx = document.getElementById('exchangeRateChart').getContext('2d');
                    
                    if (chart) chart.destroy();
                    
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels || Array.from({length: 24}, (_, i) => i + 'h'),
                            datasets: [{
                                label: 'USD to EUR',
                                data: data.rates || Array(24).fill(1.1),
                                borderColor: '#f5576c',
                                backgroundColor: 'rgba(245, 87, 108, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        function updateConversion() {
            const amount = parseFloat(document.getElementById('fromAmount').value) || 0;
            const rate = 1.1; // Mock rate
            const toAmount = amount * rate;
            const fee = toAmount * 0.005; // 0.5% fee
            const net = toAmount - fee;

            document.getElementById('toAmount').value = toAmount.toFixed(2);
            document.getElementById('exchangeFee').textContent = '$' + fee.toFixed(2);
            document.getElementById('netAmount').textContent = '$' + net.toFixed(2);
            document.getElementById('exchangeRate').textContent = `1 ${document.getElementById('fromCurrency').value} = ${rate} ${document.getElementById('toCurrency').value}`;
        }

        function swapCurrencies() {
            const from = document.getElementById('fromCurrency').value;
            const to = document.getElementById('toCurrency').value;
            document.getElementById('fromCurrency').value = to;
            document.getElementById('toCurrency').value = from;
            document.getElementById('fromCurrencyLabel').textContent = to;
            document.getElementById('toCurrencyLabel').textContent = from;
            updateConversion();
        }

        async function handleExchange(e) {
            e.preventDefault();

            const exchange = {
                from_currency: document.getElementById('fromCurrency').value,
                to_currency: document.getElementById('toCurrency').value,
                amount: parseFloat(document.getElementById('fromAmount').value),
                from_account_id: document.getElementById('fromAccount').value,
                to_account_id: document.getElementById('toAccount').value
            };

            try {
                const response = await fetch('/api/v1/currency_exchange/exchange', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exchange)
                });

                if (response.ok) {
                    alert('Exchange completed successfully!');
                    document.getElementById('exchangeForm').reset();
                    await loadExchangeStats();
                    await loadRecentExchanges();
                } else {
                    alert('Error completing exchange');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error completing exchange');
            }
        }
    </script>
</body>
</html>
