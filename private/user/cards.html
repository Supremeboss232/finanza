<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My Cards - Finanza Bank</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="/static/img/favicon.ico" rel="icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600;700&family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/static/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/lib/animate/animate.min.css" rel="stylesheet">
    <link href="/static/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Navbar Start -->
    <div class="container-fluid fixed-top px-0 wow fadeIn" data-wow-delay="0.1s">
        <nav class="navbar navbar-expand-lg navbar-light py-lg-0 px-lg-5 wow fadeIn" data-wow-delay="0.1s">
            <a href="/user/dashboard" class="navbar-brand ms-4 ms-lg-0">
                <h5 class="m-0 text-primary"><i class="fa fa-university me-2"></i>Finanza</h5>
            </a>
            <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ms-auto p-4 p-lg-0">
                    <a href="/user/dashboard" class="nav-item nav-link">Dashboard</a>
                    <a href="/user/account" class="nav-item nav-link">Account</a>
                    <a href="/user/kyc_form" class="nav-item nav-link">KYC</a>
                    <div class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Products</a>
                        <div class="dropdown-menu border-light m-0">
                            <a href="/user/cards" class="dropdown-item">Cards</a>
                            <a href="/user/deposits" class="dropdown-item">Deposits</a>
                            <a href="/user/loans" class="dropdown-item">Loans</a>
                            <a href="/user/investments" class="dropdown-item">Investments</a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Services</a>
                        <div class="dropdown-menu border-light m-0">
                            <a href="/user/analytics" class="dropdown-item">Business Analysis</a>
                            <a href="/user/treasury_portfolio" class="dropdown-item">Financial Planning</a>
                            <a href="/user/insurance" class="dropdown-item">Insurance</a>
                            <a href="/user/treasury_portfolio" class="dropdown-item">Projects</a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">More</a>
                        <div class="dropdown-menu border-light m-0">
                            <a href="/user/profile" class="dropdown-item">Profile</a>
                            <a href="/user/settings" class="dropdown-item">Settings</a>
                            <a href="/user/notifications" class="dropdown-item">Notifications</a>
                            <a href="/user/contact" class="dropdown-item">Contact/Support</a>
                            <hr class="m-2">
                            <a href="/logout" class="dropdown-item text-danger">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->
    <div class="container-fluid page-header mb-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container">
            <h1 class="display-4 pb-3 animated slideInDown">My Cards</h1>
            <nav aria-label="breadcrumb animated slideInDown">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a class="text-white" href="/user/dashboard">Home</a></li>
                    <li class="breadcrumb-item text-primary active" aria-current="page">My Cards</li>
                </ol>
            </nav>
        </div>
    </div>
    <div class="container-xxl py-5">
        <div class="container">
            <div class="row g-5">
                <div class="col-lg-12 wow fadeInUp" data-wow-delay="0.1s">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1"><i class="fas fa-credit-card text-primary me-2"></i>Card Management</h2>
                            <p class="text-muted mb-0">Manage your Finanza Bank cards with advanced features and real-time control.</p>
                        </div>
                        <div>
                            <button class="btn btn-outline-info btn-sm me-2" onclick="loadCards()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#cardRequestModal">
                                <i class="fas fa-plus me-2"></i>Request Card
                            </button>
                        </div>
                    </div>

                    <!-- Summary Statistics Cards -->
                    <div class="row mb-5">
                        <div class="col-md-3 mb-3">
                            <div class="card border-left-primary shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Cards</div>
                                            <div class="h3 mb-0 text-gray-800" id="totalCards">0</div>
                                        </div>
                                        <i class="fas fa-credit-card fa-2x text-primary"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="activeCardsCount">0 Active</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card border-left-success shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Balance</div>
                                            <div class="h3 mb-0 text-gray-800" id="totalBalance">$0.00</div>
                                        </div>
                                        <i class="fas fa-money-bill-wave fa-2x text-success"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="balanceStatus">Across all cards</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card border-left-info shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Credit Limit</div>
                                            <div class="h3 mb-0 text-gray-800" id="totalCreditLimit">$0.00</div>
                                        </div>
                                        <i class="fas fa-wallet fa-2x text-info"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="creditUsed">0% Used</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card border-left-warning shadow h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Card Types</div>
                                            <div class="h3 mb-0 text-gray-800" id="cardTypes">0</div>
                                        </div>
                                        <i class="fas fa-layer-group fa-2x text-warning"></i>
                                    </div>
                                    <div class="small text-muted mt-2" id="cardTypesList">Debit, Credit, Savings</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtering Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Filter by Type</label>
                                    <select class="form-select" id="cardTypeFilter">
                                        <option value="">All Types</option>
                                        <option value="debit">Debit Card</option>
                                        <option value="credit">Credit Card</option>
                                        <option value="savings">Savings Card</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Filter by Status</label>
                                    <select class="form-select" id="cardStatusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="blocked">Blocked</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Sort By</label>
                                    <select class="form-select" id="cardSort">
                                        <option value="date">Latest First</option>
                                        <option value="balance">Balance (High to Low)</option>
                                        <option value="type">Card Type</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Visual Display -->
                    <div class="mb-4">
                        <h4 class="mb-3"><i class="fas fa-layer-group text-primary me-2"></i>Your Cards</h4>
                        <div id="cardsVisualContainer" class="row g-4">
                            <div class="col-12 text-center text-muted" id="noCardsVisual">
                                <p class="py-4">No cards yet. Request your first card today!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Card Details Table -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-table text-primary me-2"></i>Card Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Card Number</th>
                                            <th>Type</th>
                                            <th>Balance</th>
                                            <th>Credit Limit</th>
                                            <th>Usage</th>
                                            <th>Expiry</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cardsTableBody">
                                        <tr id="noCardsTable" class="text-center">
                                            <td colspan="8" class="text-muted py-4">No cards found. Request your first card to get started.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Request Modal -->
    <div class="modal fade" id="cardRequestModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Request a New Card</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="cardRequestForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <span class="text-danger">*</span> Card Type
                                </label>
                                <select class="form-select form-select-lg" id="newCardType" required>
                                    <option value="">-- Select Card Type --</option>
                                    <option value="debit">üí≥ Debit Card (Direct access to your account)</option>
                                    <option value="credit">üí∞ Credit Card (Credit limit up to $10,000)</option>
                                    <option value="savings">üè¶ Savings Card (For savings account)</option>
                                </select>
                                <small class="text-muted d-block mt-2">Choose the type of card that best suits your needs</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Delivery Method</label>
                                <select class="form-select" id="newCardDelivery">
                                    <option value="home" selected>üè† Home Delivery (5-7 business days)</option>
                                    <option value="branch">üè¢ Pick up at Branch (Next business day)</option>
                                    <option value="courier">üöö Express Courier (2-3 business days)</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Additional Notes (Optional)</label>
                                <textarea class="form-control" id="newCardNotes" placeholder="Any special requirements or preferences..." rows="3"></textarea>
                            </div>
                            
                            <!-- Card Type Information -->
                            <div class="col-12">
                                <div class="alert alert-info mb-0">
                                    <strong>Card Type Details:</strong>
                                    <div id="cardTypeInfo" class="mt-2">
                                        <small class="text-muted d-block">Select a card type above to see details</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submitCardBtn" disabled>
                            <i class="fas fa-check me-2"></i>Request Card
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div class="modal fade" id="cardDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Card Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cardDetailContent">
                        <!-- Content populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="toggleCardBtn" onclick="toggleCardStatus()">
                        <i class="fas fa-ban me-2"></i>Block Card
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-light footer mt-5 py-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-white mb-4">Address</h5>
                    <p class="mb-2"><i class="fa fa-map-marker-alt me-3"></i>123 Street, New York, USA</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/lib/wow/wow.min.js"></script>
    <script src="/static/lib/easing/easing.min.js"></script>
    <script src="/static/lib/waypoints/waypoints.min.js"></script>
    <script src="/static/lib/counterup/counterup.min.js"></script>
    <script src="/static/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/static/js/main.js"></script>
    <script src="/static/js/user-guard.js"></script>
    <script src="/static/js/realtime.js"></script>
    <script src="/static/js/page-sync.js"></script>
    <script>
        let allCards = [];
        let currentFilter = {
            type: '',
            status: '',
            sort: 'date'
        };
        let currentCardId = null;

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount || 0);
        }

        // Load cards from database via API
        async function loadCards() {
            try {
                // Show loading state
                document.getElementById('cardsTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></td></tr>';
                
                console.log('[CARDS] Fetching cards from /api/user/cards...');
                
                const response = await fetch('/api/user/cards', {
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });
                
                console.log('[CARDS] Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[CARDS] Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText || 'Failed to load cards'}`);
                }
                
                allCards = await response.json() || [];
                
                console.log('[CARDS] Successfully loaded', allCards.length, 'cards from database');
                
                updateSummaryStats();
                filterAndSortCards();
                hideSpinner();
            } catch (error) {
                console.error('[CARDS] Error loading cards:', error);
                document.getElementById('cardsTableBody').innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4"><i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}</td></tr>`;
                showNoCards();
                hideSpinner();
            }
        }

        // Hide spinner
        function hideSpinner() {
            const spinner = document.getElementById('spinner');
            if (spinner) spinner.style.display = 'none';
        }

        // Update summary statistics
        function updateSummaryStats() {
            if (!allCards || allCards.length === 0) {
                document.getElementById('totalCards').textContent = '0';
                document.getElementById('totalBalance').textContent = '$0.00';
                document.getElementById('totalCreditLimit').textContent = '$0.00';
                document.getElementById('activeCardsCount').textContent = '0 Active';
                document.getElementById('creditUsed').textContent = '0% Used';
                document.getElementById('cardTypes').textContent = '0';
                return;
            }

            let totalBalance = 0;
            let activeCount = 0;
            let totalCreditLimit = 0;
            let typeSet = new Set();

            allCards.forEach(card => {
                const balance = card.balance || 0;
                const creditLimit = card.credit_limit || 0;
                
                totalBalance += balance;
                totalCreditLimit += creditLimit;
                if (card.status === 'active') activeCount++;
                typeSet.add(card.card_type);
            });

            const creditUsedPercentage = totalCreditLimit > 0 ? ((totalCreditLimit - totalBalance) / totalCreditLimit * 100) : 0;

            document.getElementById('totalCards').textContent = allCards.length;
            document.getElementById('totalBalance').textContent = `$${totalBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalCreditLimit').textContent = `$${totalCreditLimit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('activeCardsCount').textContent = `${activeCount} Active Card${activeCount !== 1 ? 's' : ''}`;
            document.getElementById('creditUsed').textContent = `${creditUsedPercentage.toFixed(0)}% Used`;
            document.getElementById('cardTypes').textContent = typeSet.size;
            document.getElementById('cardTypesList').textContent = Array.from(typeSet).map(t => formatCardType(t)).join(', ');
        }

        // Filter and sort cards
        function filterAndSortCards() {
            const typeFilter = document.getElementById('cardTypeFilter');
            const statusFilter = document.getElementById('cardStatusFilter');
            const sortSelect = document.getElementById('cardSort');
            
            currentFilter.type = typeFilter ? typeFilter.value : '';
            currentFilter.status = statusFilter ? statusFilter.value : '';
            currentFilter.sort = sortSelect ? sortSelect.value : 'date';

            let filtered = [...allCards];

            if (currentFilter.type) {
                filtered = filtered.filter(card => card.card_type.toLowerCase() === currentFilter.type.toLowerCase());
            }
            if (currentFilter.status) {
                filtered = filtered.filter(card => (card.status || 'active').toLowerCase() === currentFilter.status.toLowerCase());
            }

            // Sort
            filtered.sort((a, b) => {
                switch(currentFilter.sort) {
                    case 'balance':
                        return (b.balance || 0) - (a.balance || 0);
                    case 'type':
                        return (a.card_type || '').localeCompare(b.card_type || '');
                    case 'date':
                    default:
                        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                }
            });

            displayCards(filtered);
        }

        // Display cards in visual and table view
        function displayCards(cards) {
            const visualContainer = document.getElementById('cardsVisualContainer');
            const tableBody = document.getElementById('cardsTableBody');
            const noVisualMsg = document.getElementById('noCardsVisual');
            const noTableMsg = document.getElementById('noCardsTable');

            // Clear existing - safely check if elements exist
            if (visualContainer) visualContainer.innerHTML = '';
            if (tableBody) tableBody.innerHTML = '';

            if (!cards || cards.length === 0) {
                if (noVisualMsg) noVisualMsg.style.display = 'block';
                if (noTableMsg) noTableMsg.style.display = 'block';
                return;
            }

            if (noVisualMsg) noVisualMsg.style.display = 'none';
            if (noTableMsg) noTableMsg.style.display = 'none';

            // Display cards and table rows
            cards.forEach(card => {
                const visualCard = createCardVisual(card);
                if (visualContainer) visualContainer.appendChild(visualCard);

                const row = createCardTableRow(card);
                if (tableBody) tableBody.appendChild(row);
            });
        }

        // Create visual card
        function createCardVisual(card) {
            const div = document.createElement('div');
            div.className = 'col-md-6 col-lg-4';
            
            const statusColor = {
                'active': '#28a745',
                'inactive': '#ffc107',
                'blocked': '#dc3545'
            }[card.status || 'active'] || '#6c757d';

            const balance = card.balance || 0;
            const creditLimit = card.credit_limit || 0;
            const usage = creditLimit > 0 ? ((creditLimit - balance) / creditLimit * 100) : 0;

            const lastFour = card.card_number.slice(-4);
            const expiryDate = card.expiry_date || 'N/A';

            div.innerHTML = `
                <div class="card h-100 shadow-sm border-0 cursor-pointer" style="transition: transform 0.2s; cursor: pointer; background: linear-gradient(135deg, ${statusColor}15 0%, ${statusColor}05 100%);" 
                     onmouseover="this.style.transform='translateY(-5px)'" 
                     onmouseout="this.style.transform='translateY(0)'"
                     onclick="viewCardDetail(${card.id})">
                    <div class="card-body" style="border-left: 4px solid ${statusColor};">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <h6 class="card-title fw-bold mb-1" style="color: ${statusColor};">${formatCardType(card.card_type)}</h6>
                                <small class="text-muted">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${lastFour}</small>
                            </div>
                            <span class="badge" style="background-color: ${statusColor};">${(card.status || 'active').charAt(0).toUpperCase() + (card.status || 'active').slice(1)}</span>
                        </div>
                        
                        <div class="mb-4">
                            <small class="text-muted">CARD BALANCE</small>
                            <h4 class="mb-0" style="color: ${statusColor};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Credit Limit Usage</small>
                                <strong>${usage.toFixed(0)}%</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="background-color: ${statusColor}; width: ${Math.min(usage, 100)}%;" role="progressbar" aria-valuenow="${usage}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <small class="text-muted d-block">Credit Limit</small>
                                <strong>$${creditLimit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Expires</small>
                                <strong>${expiryDate}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light border-top-0">
                        <button class="btn btn-sm w-100" style="background-color: ${statusColor}; color: white; border: none;" onclick="event.stopPropagation(); viewCardDetail(${card.id})">
                            <i class="fas fa-eye me-1"></i>View Details
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        // Create table row
        function createCardTableRow(card) {
            const tr = document.createElement('tr');
            const balance = card.balance || 0;
            const creditLimit = card.credit_limit || 0;
            const usage = creditLimit > 0 ? ((creditLimit - balance) / creditLimit * 100) : 0;
            const statusColor = {
                'active': 'success',
                'inactive': 'warning',
                'blocked': 'danger'
            }[card.status || 'active'] || 'secondary';

            const lastFour = card.card_number.slice(-4);

            tr.innerHTML = `
                <td class="fw-bold">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${lastFour}</td>
                <td>${formatCardType(card.card_type)}</td>
                <td class="text-success fw-bold">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>$${creditLimit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>
                    <div class="progress" style="height: 20px; width: 100px;">
                        <div class="progress-bar" style="width: ${Math.min(usage, 100)}%;" role="progressbar" 
                             aria-valuenow="${usage}" aria-valuemin="0" aria-valuemax="100">
                            ${usage.toFixed(0)}%
                        </div>
                    </div>
                </td>
                <td>${card.expiry_date || 'N/A'}</td>
                <td><span class="badge bg-${statusColor}">${(card.status || 'active').charAt(0).toUpperCase() + (card.status || 'active').slice(1)}</span></td>
                <td><button class="btn btn-sm btn-outline-primary" onclick="viewCardDetail(${card.id})"><i class="fas fa-eye"></i></button></td>
            `;
            return tr;
        }

        // Format card type
        function formatCardType(type) {
            const types = {
                'debit': 'üí≥ Debit Card',
                'credit': 'üí∞ Credit Card',
                'savings': 'üè¶ Savings Card'
            };
            return types[type?.toLowerCase()] || type || 'Card';
        }

        // View card detail
        function viewCardDetail(cardId) {
            const card = allCards.find(c => c.id === cardId);
            if (!card) return;

            currentCardId = cardId;
            const balance = card.balance || 0;
            const creditLimit = card.credit_limit || 0;
            const usage = creditLimit > 0 ? ((creditLimit - balance) / creditLimit * 100) : 0;
            const lastFour = card.card_number.slice(-4);

            const detailContent = document.getElementById('cardDetailContent');

            detailContent.innerHTML = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="mb-3">${formatCardType(card.card_type)}</h5>
                        <div class="alert alert-info">
                            <strong>Card Status:</strong> <span class="badge bg-info">${(card.status || 'active').toUpperCase()}</span>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Card Number</h6>
                        <h5 class="text-primary">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${lastFour}</h5>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Card Balance</h6>
                        <h5 class="text-success">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h5>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Credit Limit</h6>
                        <h5 class="text-warning">$${creditLimit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h5>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Available Credit</h6>
                        <h5 class="text-info">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h5>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="text-muted text-uppercase mb-3">Credit Limit Usage</h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-warning" style="width: ${Math.min(usage, 100)}%;" role="progressbar" 
                             aria-valuenow="${usage}" aria-valuemin="0" aria-valuemax="100">
                            ${usage.toFixed(1)}% Used
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 border-end">
                        <h6 class="text-muted text-uppercase mb-2">Expiry Date</h6>
                        <p class="mb-0"><strong>${card.expiry_date || 'N/A'}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2">Card Holder</h6>
                        <p class="mb-0"><strong>${card.card_holder_name || 'N/A'}</strong></p>
                    </div>
                </div>
            `;

            const toggleBtn = document.getElementById('toggleCardBtn');
            if (card.status === 'active') {
                toggleBtn.innerHTML = '<i class="fas fa-ban me-2"></i>Block Card';
                toggleBtn.className = 'btn btn-danger';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-check me-2"></i>Unblock Card';
                toggleBtn.className = 'btn btn-success';
            }

            const modal = new bootstrap.Modal(document.getElementById('cardDetailModal'));
            modal.show();
        }

        // Toggle card status
        async function toggleCardStatus() {
            if (!currentCardId) return;

            const card = allCards.find(c => c.id === currentCardId);
            if (!card) return;

            const newStatus = card.status === 'active' ? 'blocked' : 'active';

            try {
                const response = await fetch(`/api/user/cards/${currentCardId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to update card status');
                
                alert(`Card ${newStatus === 'blocked' ? 'blocked' : 'unblocked'} successfully!`);
                
                const detailModal = bootstrap.Modal.getInstance(document.getElementById('cardDetailModal'));
                if (detailModal) detailModal.hide();
                
                loadCards();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Show no cards message
        function showNoCards() {
            const noVisualMsg = document.getElementById('noCardsVisual');
            const noTableMsg = document.getElementById('noCardsTable');
            if (noVisualMsg) noVisualMsg.style.display = 'block';
            if (noTableMsg) noTableMsg.style.display = 'block';
        }

        // Setup card request form
        function setupCardRequestForm() {
            const form = document.getElementById('cardRequestForm');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const cardType = document.getElementById('newCardType').value;
                const deliveryMethod = document.getElementById('newCardDelivery').value;
                const notes = document.getElementById('newCardNotes').value;

                if (!cardType) {
                    alert('Please select a card type');
                    return;
                }

                try {
                    // Disable submit button during request
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

                    console.log('[CARD_REQUEST] Sending card request');
                    console.log('[CARD_REQUEST] Card Type:', cardType);
                    console.log('[CARD_REQUEST] Delivery Method:', deliveryMethod);

                    // Send POST request with card data in JSON body
                    const response = await fetch('/api/user/cards', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            card_type: cardType
                        }),
                        credentials: 'include'
                    });

                    console.log('[CARD_REQUEST] Response status:', response.status, response.statusText);

                    if (!response.ok) {
                        let errorMsg = `HTTP ${response.status}: Failed to request card`;
                        try {
                            const error = await response.json();
                            errorMsg = error.detail || error.message || errorMsg;
                            console.error('[CARD_REQUEST] API Error:', error);
                        } catch (e) {
                            const text = await response.text();
                            console.error('[CARD_REQUEST] Response text:', text);
                            errorMsg = text || errorMsg;
                        }
                        throw new Error(errorMsg);
                    }
                    
                    const result = await response.json();
                    
                    console.log('[CARD_REQUEST] Card created successfully:', result);
                    
                    // Reset form
                    form.reset();
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cardRequestModal'));
                    if (modal) modal.hide();
                    
                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    
                    // Show success message with card details
                    const successMsg = `
${formatCardType(result.card_type)} requested successfully!

Card Details:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Card Number: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${result.card_number}
Expiry Date: ${result.expiry_date}
Credit Limit: ${formatCurrency(result.credit_limit)}
Status: ${result.status}

Your card will be delivered via ${deliveryMethod === 'home' ? 'Home Delivery' : deliveryMethod === 'branch' ? 'Branch Pickup' : 'Express Courier'} within the specified timeframe.`;
                    alert(successMsg);
                    
                    // Reload cards list
                    console.log('[CARD_REQUEST] Reloading cards list...');
                    await loadCards();
                    
                } catch (error) {
                    console.error('[CARD_REQUEST] Error requesting card:', error);
                    alert('Error requesting card:\n' + error.message);
                    
                    // Re-enable submit button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Request Card';
                }
            });
        }

        // Setup filter and sort event listeners
        function setupFilterListeners() {
            const typeFilter = document.getElementById('cardTypeFilter');
            const statusFilter = document.getElementById('cardStatusFilter');
            const sortSelect = document.getElementById('cardSort');
            
            if (typeFilter) typeFilter.addEventListener('change', filterAndSortCards);
            if (statusFilter) statusFilter.addEventListener('change', filterAndSortCards);
            if (sortSelect) sortSelect.addEventListener('change', filterAndSortCards);
            
            console.log('[FILTERS] Event listeners setup for card filters and sorting');
        }

        // Load cards on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupFilterListeners();
                setupCardRequestForm();
                loadCards();
            });
        } else {
            setupFilterListeners();
            setupCardRequestForm();
            loadCards();
        }

        // Handle card type selection in modal
        const cardTypeSelect = document.getElementById('newCardType');
        if (cardTypeSelect) {
            cardTypeSelect.addEventListener('change', function(e) {
                const cardType = this.value;
                const submitBtn = document.getElementById('submitCardBtn');
                const infoDiv = document.getElementById('cardTypeInfo');
                
                if (cardType) {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }

                const cardInfo = {
                    debit: {
                        title: 'üí≥ Debit Card',
                        features: [
                            'Direct access to your checking account',
                            'No credit limits or interest charges',
                            'Real-time transaction notifications',
                            'Enhanced security and fraud protection',
                            'Withdraw from any ATM',
                            'Transaction limit: $10,000/day'
                        ]
                    },
                    credit: {
                        title: 'üí∞ Credit Card',
                        features: [
                            'Build your credit history',
                            'Credit limit up to $10,000',
                            'Earn rewards on purchases',
                            '0% interest for first 3 months',
                            'Flexible payment options',
                            'Purchase protection and warranties'
                        ]
                    },
                    savings: {
                        title: 'üè¶ Savings Card',
                        features: [
                            'Exclusive for savings accounts',
                            'Earn interest on every purchase',
                            'Automatic savings features',
                            'No overdraft fees',
                            'Transfer limits to prevent overspending',
                            'Special benefits on withdrawals'
                        ]
                    }
                };

                if (cardInfo[cardType]) {
                    const info = cardInfo[cardType];
                    infoDiv.innerHTML = `
                        <strong>${info.title}</strong>
                        <ul class="mb-0 mt-2">
                            ${info.features.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    infoDiv.innerHTML = '<small class="text-muted d-block">Select a card type above to see details</small>';
                }
            });
        }
    </script>

    <style>
        .border-left-primary {
            border-left: 4px solid #0d6efd;
        }
        .border-left-success {
            border-left: 4px solid #28a745;
        }
        .border-left-info {
            border-left: 4px solid #17a2b8;
        }
        .border-left-warning {
            border-left: 4px solid #ffc107;
        }
        .text-xs {
            font-size: 0.75rem;
        }
        .text-gray-800 {
            color: #2e3338;
        }
        .shadow {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .shadow-sm {
            box-shadow: 0 0.1rem 0.3rem 0 rgba(0, 0, 0, 0.1);
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .card {
            border: 1px solid #e3e6f0;
        }
        .card-header {
            border-bottom: 1px solid #e3e6f0;
        }
        .progress {
            background-color: #e3e6f0;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .badge {
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
        }
    </style>
</body>

</html>