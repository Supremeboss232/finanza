<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Deposit - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body { background: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        .navbar { background: var(--primary-gradient); box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .navbar-brand { font-weight: 700; font-size: 1.5rem; color: white; }

        .page-header { background: var(--primary-gradient); color: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; }
        .page-header h1 { font-weight: 700; margin-bottom: 0.5rem; }

        .metric-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5rem; transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .metric-card .metric-value { font-size: 2.5rem; font-weight: 700; color: #667eea; }
        .metric-card .metric-label { font-size: 0.875rem; color: #6b7280; font-weight: 500; margin-top: 0.5rem; }
        .metric-icon { font-size: 2rem; color: #667eea; margin-bottom: 1rem; }

        .chart-container { position: relative; height: 300px; margin-bottom: 2rem; }

        .data-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .data-table table { margin-bottom: 0; }
        .data-table thead { background: #f9fafb; border-bottom: 2px solid #e5e7eb; }
        .data-table th { font-weight: 600; color: #374151; padding: 1rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table td { padding: 1rem; vertical-align: middle; }

        .badge { padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-processed { background: #d1fae5; color: #065f46; }
        .badge-pending { background: #fef3c7; color: #78350f; }
        .badge-rejected { background: #fee2e2; color: #7f1d1d; }

        .action-buttons { display: flex; gap: 0.5rem; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }

        .btn-primary { background: #667eea; border-color: #667eea; }
        .btn-primary:hover { background: #5568d3; border-color: #5568d3; }

        .modal-header { background: var(--primary-gradient); color: white; }
        .modal-header .btn-close { filter: brightness(0) invert(1); }

        .form-label { font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
        .form-control, .form-select { border: 1px solid #d1d5db; border-radius: 6px; padding: 0.7rem; }
        .form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }

        .section-divider { display: flex; align-items: center; margin: 2rem 0 1.5rem; gap: 1rem; }
        .section-divider h3 { margin: 0; font-weight: 700; color: #1f2937; font-size: 1.25rem; }
        .section-divider hr { flex: 1; border-color: #e5e7eb; }

        .image-preview { max-width: 200px; max-height: 200px; margin: 1rem 0; border-radius: 6px; border: 1px solid #e5e7eb; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="fas fa-camera"></i> Mobile Deposit</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link text-white" href="javascript:navigateTo('/user/admin/')">&larr; Dashboard</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-mobile-alt"></i> Mobile Deposit Management</h1>
            <p class="mb-0">Check capture, image verification, and OCR processing</p>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-check"></i></div>
                    <div class="metric-value" id="processedDeposits">0</div>
                    <div class="metric-label">Processed Today</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-hourglass-half"></i></div>
                    <div class="metric-value" id="pendingReview">0</div>
                    <div class="metric-label">Pending Review</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="metric-value" id="totalDeposited">$0M</div>
                    <div class="metric-label">Total Deposited</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="metric-value" id="rejectedCount">0</div>
                    <div class="metric-label">Rejected</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="data-table">
                    <div style="padding: 1.5rem;">
                        <h5 class="mb-3">Deposit Status (24h)</h5>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="data-table">
                    <div style="padding: 1.5rem;">
                        <h5 class="mb-3">OCR Quality Distribution</h5>
                        <div class="chart-container">
                            <canvas id="ocrChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Deposits Table -->
        <div class="section-divider">
            <h3>Recent Deposits</h3>
            <hr>
        </div>

        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Deposit ID</th>
                        <th>User</th>
                        <th>Account</th>
                        <th>Amount</th>
                        <th>Check #</th>
                        <th>Deposit Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="depositsTable">
                    <tr><td colspan="8" class="text-center text-muted py-4">Loading deposits...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Check Images Table -->
        <div class="section-divider">
            <h3>Check Image Verification</h3>
            <hr>
        </div>

        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Image ID</th>
                        <th>Deposit ID</th>
                        <th>Side</th>
                        <th>Quality Score</th>
                        <th>Clarity</th>
                        <th>Size (KB)</th>
                        <th>Uploaded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="imagesTable">
                    <tr><td colspan="8" class="text-center text-muted py-4">Loading images...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- OCR Results Table -->
        <div class="section-divider">
            <h3>OCR Processing Results</h3>
            <hr>
        </div>

        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>OCR ID</th>
                        <th>Deposit ID</th>
                        <th>Check Amount</th>
                        <th>Routing #</th>
                        <th>Account #</th>
                        <th>Confidence</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ocrTable">
                    <tr><td colspan="8" class="text-center text-muted py-4">Loading OCR results...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Review Image Modal -->
    <div class="modal fade" id="reviewImageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-image"></i> Review Check Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img id="previewImage" class="image-preview w-100" src="" alt="Check image">
                    <div class="mt-3">
                        <p><strong>Quality Score:</strong> <span id="qualityScore">--</span>%</p>
                        <p><strong>Clarity:</strong> <span id="imageclarity">--</span>%</p>
                        <p><strong>Size:</strong> <span id="imageSize">--</span> KB</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Review Notes</label>
                        <textarea class="form-control" id="reviewNotes" rows="3" placeholder="Enter review notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="rejectImage()">Reject</button>
                    <button type="button" class="btn btn-success" onclick="approveImage()">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approve Deposit Modal -->
    <div class="modal fade" id="approveDepositModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-check-circle"></i> Approve Deposit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="approveDepositForm">
                        <input type="hidden" id="depositIdApprove">
                        <div class="mb-3">
                            <label class="form-label">Deposit Amount</label>
                            <input type="text" class="form-control" id="depositAmount" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Processing Notes</label>
                            <textarea class="form-control" id="processingNotes" rows="3" placeholder="Enter processing notes..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Approve Deposit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="/admin_static/js/admin-utils.js"></script>

    <script>
        let statusChart, ocrChart;
        let currentImageId = null, currentDepositId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
            loadMobileDepositMetrics();
            loadDeposits();
            loadCheckImages();
            loadOCRResults();
            initCharts();
        });

        async function loadMobileDepositMetrics() {
            try {
                const response = await fetchAPI('/api/v1/mobile-deposit/metrics');
                if (response.success) {
                    document.getElementById('processedDeposits').textContent = response.data.processed_today || 0;
                    document.getElementById('pendingReview').textContent = response.data.pending_review || 0;
                    document.getElementById('totalDeposited').textContent = formatCurrency(response.data.total_deposited || 0, true);
                    document.getElementById('rejectedCount').textContent = response.data.rejected || 0;
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadDeposits() {
            try {
                const response = await fetchAPI('/api/v1/mobile-deposit/deposits');
                const table = document.getElementById('depositsTable');
                
                if (!response.success || !response.data?.length) {
                    table.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No deposits found</td></tr>';
                    return;
                }

                table.innerHTML = response.data.map(deposit => `
                    <tr>
                        <td><strong>#${deposit.id}</strong></td>
                        <td>${deposit.user_email}</td>
                        <td>${deposit.account_number}</td>
                        <td>${formatCurrency(deposit.amount)}</td>
                        <td>${deposit.check_number}</td>
                        <td>${formatDate(deposit.deposit_date)}</td>
                        <td><span class="badge badge-${getStatusClass(deposit.status)}">${deposit.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="reviewDeposit('${deposit.id}', '${deposit.amount}')">Review</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading deposits:', error);
            }
        }

        async function loadCheckImages() {
            try {
                const response = await fetchAPI('/api/v1/mobile-deposit/images');
                const table = document.getElementById('imagesTable');
                
                if (!response.success || !response.data?.length) {
                    table.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No images found</td></tr>';
                    return;
                }

                table.innerHTML = response.data.map(img => `
                    <tr>
                        <td><strong>#${img.id}</strong></td>
                        <td>#${img.deposit_id}</td>
                        <td><span class="badge bg-info">${img.side}</span></td>
                        <td><strong>${img.quality_score}%</strong></td>
                        <td>${img.clarity}%</td>
                        <td>${(img.file_size / 1024).toFixed(1)}</td>
                        <td>${formatDate(img.uploaded_date)}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="viewImage('${img.id}')">View</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        async function loadOCRResults() {
            try {
                const response = await fetchAPI('/api/v1/mobile-deposit/ocr-results');
                const table = document.getElementById('ocrTable');
                
                if (!response.success || !response.data?.length) {
                    table.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No OCR results</td></tr>';
                    return;
                }

                table.innerHTML = response.data.map(ocr => `
                    <tr>
                        <td><strong>#${ocr.id}</strong></td>
                        <td>#${ocr.deposit_id}</td>
                        <td>${formatCurrency(ocr.check_amount)}</td>
                        <td>${ocr.routing_number}</td>
                        <td>${ocr.account_number}</td>
                        <td><strong>${ocr.confidence}%</strong></td>
                        <td><span class="badge ${ocr.status === 'verified' ? 'bg-success' : 'bg-warning'}">${ocr.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="verifyOCR('${ocr.id}')">Review</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading OCR results:', error);
            }
        }

        function getStatusClass(status) {
            const map = { 'processed': 'processed', 'pending': 'pending', 'rejected': 'rejected', 'approved': 'processed' };
            return map[status] || 'pending';
        }

        function initCharts() {
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Processed', 'Pending', 'Rejected'],
                    datasets: [{
                        data: [65, 25, 10],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            const ocrCtx = document.getElementById('ocrChart').getContext('2d');
            ocrChart = new Chart(ocrCtx, {
                type: 'bar',
                data: {
                    labels: ['Excellent', 'Good', 'Fair', 'Poor'],
                    datasets: [{
                        label: 'Image Quality',
                        data: [45, 30, 15, 10],
                        backgroundColor: '#667eea',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function viewImage(imageId) {
            currentImageId = imageId;
            document.getElementById('previewImage').src = `/api/v1/mobile-deposit/images/${imageId}/preview`;
            document.getElementById('qualityScore').textContent = '92';
            document.getElementById('imageclarity').textContent = '88';
            document.getElementById('imageSize').textContent = '245';
            new bootstrap.Modal(document.getElementById('reviewImageModal')).show();
        }

        async function approveImage() {
            try {
                const response = await fetchAPI(`/api/v1/mobile-deposit/images/${currentImageId}/approve`, {
                    method: 'POST',
                    body: JSON.stringify({ notes: document.getElementById('reviewNotes').value })
                });
                if (response.success) {
                    showAlert('Image approved successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('reviewImageModal')).hide();
                    loadCheckImages();
                }
            } catch (error) {
                showAlert('Error approving image', 'danger');
            }
        }

        async function rejectImage() {
            try {
                const response = await fetchAPI(`/api/v1/mobile-deposit/images/${currentImageId}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({ notes: document.getElementById('reviewNotes').value })
                });
                if (response.success) {
                    showAlert('Image rejected', 'warning');
                    bootstrap.Modal.getInstance(document.getElementById('reviewImageModal')).hide();
                    loadCheckImages();
                }
            } catch (error) {
                showAlert('Error rejecting image', 'danger');
            }
        }

        function reviewDeposit(depositId, amount) {
            currentDepositId = depositId;
            document.getElementById('depositIdApprove').value = depositId;
            document.getElementById('depositAmount').value = formatCurrency(parseFloat(amount));
            new bootstrap.Modal(document.getElementById('approveDepositModal')).show();
        }

        function verifyOCR(ocrId) {
            showAlert(`Verifying OCR result #${ocrId}...`, 'info');
        }

        document.getElementById('approveDepositForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const response = await fetchAPI(`/api/v1/mobile-deposit/deposits/${currentDepositId}/approve`, {
                    method: 'POST',
                    body: JSON.stringify({ notes: document.getElementById('processingNotes').value })
                });
                if (response.success) {
                    showAlert('Deposit approved successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('approveDepositModal')).hide();
                    loadDeposits();
                    loadMobileDepositMetrics();
                }
            } catch (error) {
                showAlert('Error approving deposit', 'danger');
            }
        });
    </script>
    <script src="/static/js/admin-guard.js"></script>
</body>
</html>
