<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporting & Analytics - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body { background: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        .navbar { background: var(--primary-gradient); box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .navbar-brand { font-weight: 700; font-size: 1.5rem; color: white; }

        .page-header { background: var(--primary-gradient); color: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; }
        .page-header h1 { font-weight: 700; margin-bottom: 0.5rem; }

        .metric-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5rem; transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .metric-card .metric-value { font-size: 2.5rem; font-weight: 700; color: #667eea; }
        .metric-card .metric-label { font-size: 0.875rem; color: #6b7280; font-weight: 500; margin-top: 0.5rem; }
        .metric-icon { font-size: 2rem; color: #667eea; margin-bottom: 1rem; }

        .chart-container { position: relative; height: 300px; margin-bottom: 2rem; }

        .data-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .data-table table { margin-bottom: 0; }
        .data-table thead { background: #f9fafb; border-bottom: 2px solid #e5e7eb; }
        .data-table th { font-weight: 600; color: #374151; padding: 1rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table td { padding: 1rem; vertical-align: middle; }

        .badge { padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }

        .action-buttons { display: flex; gap: 0.5rem; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }

        .btn-primary { background: #667eea; border-color: #667eea; }
        .btn-primary:hover { background: #5568d3; border-color: #5568d3; }

        .modal-header { background: var(--primary-gradient); color: white; }
        .modal-header .btn-close { filter: brightness(0) invert(1); }

        .form-label { font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
        .form-control, .form-select { border: 1px solid #d1d5db; border-radius: 6px; padding: 0.7rem; }
        .form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }

        .section-divider { display: flex; align-items: center; margin: 2rem 0 1.5rem; gap: 1rem; }
        .section-divider h3 { margin: 0; font-weight: 700; color: #1f2937; font-size: 1.25rem; }
        .section-divider hr { flex: 1; border-color: #e5e7eb; }

        .filter-section { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="fas fa-chart-bar"></i> Reporting & Analytics</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link text-white" href="javascript:navigateTo('/user/admin/')">&larr; Dashboard</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-chart-line"></i> Reporting & Analytics</h1>
            <p class="mb-0">Comprehensive business intelligence and regulatory reporting</p>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-transactions"></i></div>
                    <div class="metric-value" id="totalTransactions">0</div>
                    <div class="metric-label">Total Transactions</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="metric-value" id="totalVolume">$0M</div>
                    <div class="metric-label">Transaction Volume</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-users"></i></div>
                    <div class="metric-value" id="activeUsers">0</div>
                    <div class="metric-label">Active Users</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="metric-value" id="completionRate">0%</div>
                    <div class="metric-label">Completion Rate</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="data-table">
                    <div style="padding: 1.5rem;">
                        <h5 class="mb-3">Revenue Trend (30 Days)</h5>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="data-table">
                    <div style="padding: 1.5rem;">
                        <h5 class="mb-3">Transaction Types</h5>
                        <div class="chart-container">
                            <canvas id="typesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Builder -->
        <div class="section-divider">
            <h3>Report Builder</h3>
            <hr>
        </div>

        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" id="reportType">
                        <option value="">Select Type...</option>
                        <option value="transaction">Transaction Report</option>
                        <option value="user_demographics">User Demographics</option>
                        <option value="revenue">Revenue Report</option>
                        <option value="compliance">Compliance Report</option>
                        <option value="regulatory">Regulatory Report</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <select class="form-select" id="dateRange">
                        <option value="today">Today</option>
                        <option value="7days">Last 7 Days</option>
                        <option value="30days" selected>Last 30 Days</option>
                        <option value="90days">Last 90 Days</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Export Format</label>
                    <select class="form-select" id="exportFormat">
                        <option value="pdf">PDF</option>
                        <option value="csv">CSV</option>
                        <option value="xlsx">Excel</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="generateReport()">
                        <i class="fas fa-download"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Reports Table -->
        <div class="section-divider">
            <h3>Recent Reports</h3>
            <hr>
        </div>

        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Report ID</th>
                        <th>Report Type</th>
                        <th>Date Range</th>
                        <th>Generated Date</th>
                        <th>Records</th>
                        <th>Status</th>
                        <th>File</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsTable">
                    <tr><td colspan="8" class="text-center text-muted py-4">Loading reports...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Scheduled Reports -->
        <div class="section-divider">
            <h3>Scheduled Reports</h3>
            <hr>
        </div>

        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Schedule ID</th>
                        <th>Report Type</th>
                        <th>Frequency</th>
                        <th>Next Run</th>
                        <th>Recipients</th>
                        <th>Status</th>
                        <th>Last Run</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="schedulesTable">
                    <tr><td colspan="8" class="text-center text-muted py-4">Loading schedules...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Report Modal -->
    <div class="modal fade" id="createReportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-pdf"></i> Create Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createReportForm">
                        <div class="mb-3">
                            <label class="form-label">Report Name</label>
                            <input type="text" class="form-control" id="reportName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sections to Include</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeMetrics" checked>
                                <label class="form-check-label" for="includeMetrics">Key Metrics</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                                <label class="form-check-label" for="includeCharts">Charts & Visualizations</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeTables" checked>
                                <label class="form-check-label" for="includeTables">Data Tables</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Create Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="/admin_static/js/admin-utils.js"></script>

    <script>
        let revenueChart, typesChart;

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
            loadReportingMetrics();
            loadReports();
            loadSchedules();
            initCharts();
        });

        async function loadReportingMetrics() {
            try {
                const response = await fetchAPI('/api/v1/reports/metrics');
                if (response.success) {
                    document.getElementById('totalTransactions').textContent = response.data.total_transactions || 0;
                    document.getElementById('totalVolume').textContent = formatCurrency(response.data.total_volume || 0, true);
                    document.getElementById('activeUsers').textContent = response.data.active_users || 0;
                    document.getElementById('completionRate').textContent = (response.data.completion_rate || 0) + '%';
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadReports() {
            try {
                const response = await fetchAPI('/api/v1/reports');
                const table = document.getElementById('reportsTable');
                
                if (!response.success || !response.data?.length) {
                    table.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No reports generated</td></tr>';
                    return;
                }

                table.innerHTML = response.data.map(report => `
                    <tr>
                        <td><strong>#${report.id}</strong></td>
                        <td>${report.report_type}</td>
                        <td>${report.date_range}</td>
                        <td>${formatDate(report.generated_date)}</td>
                        <td><strong>${report.record_count}</strong></td>
                        <td><span class="badge bg-success">Completed</span></td>
                        <td>${report.file_name}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="downloadReport('${report.id}')">Download</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        async function loadSchedules() {
            try {
                const response = await fetchAPI('/api/v1/reports/schedules');
                const table = document.getElementById('schedulesTable');
                
                if (!response.success || !response.data?.length) {
                    table.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No scheduled reports</td></tr>';
                    return;
                }

                table.innerHTML = response.data.map(schedule => `
                    <tr>
                        <td><strong>#${schedule.id}</strong></td>
                        <td>${schedule.report_type}</td>
                        <td><span class="badge bg-info">${schedule.frequency}</span></td>
                        <td>${formatDate(schedule.next_run)}</td>
                        <td>${schedule.recipients}</td>
                        <td><span class="badge ${schedule.is_active ? 'bg-success' : 'bg-secondary'}">${schedule.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${schedule.last_run ? formatDate(schedule.last_run) : 'Never'}</td>
                        <td><button class="btn btn-sm btn-warning" onclick="editSchedule('${schedule.id}')">Edit</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }

        function initCharts() {
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 5', 'Day 10', 'Day 15', 'Day 20', 'Day 25', 'Day 30'],
                    datasets: [{
                        label: 'Revenue ($K)',
                        data: [45, 52, 48, 61, 55, 67, 72],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const typesCtx = document.getElementById('typesChart').getContext('2d');
            typesChart = new Chart(typesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Transfer', 'Payment', 'Deposit', 'Withdrawal'],
                    datasets: [{
                        data: [40, 30, 20, 10],
                        backgroundColor: ['#667eea', '#764ba2', '#f59e0b', '#10b981'],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const exportFormat = document.getElementById('exportFormat').value;
            if (!reportType) {
                showAlert('Please select a report type', 'warning');
                return;
            }
            showAlert(`Generating ${reportType} report as ${exportFormat}...`, 'info');
        }

        function downloadReport(reportId) {
            showAlert(`Downloading report #${reportId}...`, 'success');
        }

        function editSchedule(scheduleId) {
            showAlert(`Editing schedule #${scheduleId}...`, 'info');
        }

        document.getElementById('createReportForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const response = await fetchAPI('/api/v1/reports', {
                    method: 'POST',
                    body: JSON.stringify({
                        report_name: document.getElementById('reportName').value,
                        include_metrics: document.getElementById('includeMetrics').checked,
                        include_charts: document.getElementById('includeCharts').checked,
                        include_tables: document.getElementById('includeTables').checked
                    })
                });
                if (response.success) {
                    showAlert('Report created successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createReportModal')).hide();
                    loadReports();
                }
            } catch (error) {
                showAlert('Error creating report', 'danger');
            }
        });
    </script>
    <script src="/static/js/admin-guard.js"></script>
</body>
</html>
